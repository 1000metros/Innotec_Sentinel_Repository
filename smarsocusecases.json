{"value":[{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/BuiltInFusion","name":"BuiltInFusion","etag":"\"6c028264-0000-0d00-0000-62b568580000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Fusion","properties":{"displayName":"Advanced Multistage Attack Detection","description":"Microsoft Sentinel uses Fusion, a correlation engine based on scalable machine learning algorithms, to automatically detect multistage attacks by identifying combinations of anomalous behaviors and suspicious activities that are observed at various stages of the kill chain. On the basis of these discoveries, Azure Sentinel generates incidents that would otherwise be very difficult to catch. By design, these incidents are low-volume, high-fidelity, and high-severity, which is why this detection is turned ON by default.\n\nSince Fusion correlates multiple signals from various products to detect advanced multistage attacks, successful Fusion detections are presented as Fusion incidents on the Microsoft Sentinel Incidents page. This rule covers the following detections:\n- Fusion for emerging threats\n- Fusion for ransomware\n- Scenario-based Fusion detections (122 scenarios)\n\nTo enable these detections, we recommend you configure the following data connectors for best results:\n- Out-of-the-box anomaly detections\n- Azure Active Directory Identity Protection\n- Azure Defender\n- Azure Defender for IoT\n- Microsoft 365 Defender\n- Microsoft Cloud App Security    \n- Microsoft Defender for Endpoint\n- Microsoft Defender for Identity\n- Microsoft Defender for Office 365\n- Scheduled analytics rules, both built-in and those created by your security analysts. Analytics rules must contain kill-chain (tactics) and entity mapping information in order to be used by Fusion.\n\nFor the full description of each detection that is supported by Fusion, go to https://aka.ms/SentinelFusion.","alertRuleTemplateName":"f71aba3d-28fb-450b-b192-4e76a83015c8","tactics":["Collection","CommandAndControl","CredentialAccess","DefenseEvasion","Discovery","Execution","Exfiltration","Impact","InitialAccess","LateralMovement","Persistence","PrivilegeEscalation"],"severity":"High","enabled":true,"lastModifiedUtc":"2022-06-24T07:31:35.9643616Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/3ee5a1e6-8d02-417c-a2f3-11015385505a","name":"3ee5a1e6-8d02-417c-a2f3-11015385505a","etag":"\"9102e64f-0000-0d00-0000-62bd99e20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let max_delete = 3;\r\nlet Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where OfficeWorkload =~ \"MicrosoftTeams\"\r\n\t| where Operation =~ \"TeamDeleted\" and UserType != \"Application\"\r\n\t| summarize ['Number of Teams Deleted'] = dcount(TeamName), [\"Teams Deleted\"] = make_set(TeamName) by UserId\r\n\t| where ['Number of Teams Deleted'] > max_delete\r\n\t};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080319 - Multiple Teams deleted by a single user","enabled":true,"description":"Multiple Teams deleted by a single user","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T12:41:06.1665609Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/2fc822a9-950f-419b-ade3-3c4b5b08faf1","name":"2fc822a9-950f-419b-ade3-3c4b5b08faf1","etag":"\"05002dfc-0000-0d00-0000-62c059200000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\n    | where (Operation == \"SharingInvitationCreated\" or Operation == \"AnonymousLinkCreated\")\n    | summarize count() by UserId\n    | where count_ >= 3\n    | extend AccountCustomEntity = UserId\n};\nunion withsource=\"TenantDetection\"  Mango\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080203 - O365 public link created by user to share files","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T14:41:35.880261Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/bb4ef0c6-ad61-4f5c-8e8b-e8d6b2785c05","name":"bb4ef0c6-ad61-4f5c-8e8b-e8d6b2785c05","etag":"\"91025f4e-0000-0d00-0000-62bd999e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let time_ago = 1d;\r\nlet Mango = view () {\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where TimeGenerated > ago(time_ago)\r\n\t| where RecordType == \"MicrosoftTeams\" and Operation == \"MemberAdded\" \r\n\t| where UserType == \"Regular\" and UserId contains \"ext\"\r\n\t| project TimeAdded=TimeGenerated, UserId, Operation, ItemName\r\n\t| join (\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where TimeGenerated > ago(time_ago)\r\n\t| where RecordType == \"MicrosoftTeams\" and Operation == \"MemberRemoved\" \r\n\t| where UserType == \"Regular\" and UserId contains \"ext\"\r\n\t| project TimeDeleted=TimeGenerated, Operation, UserId, ItemName) on UserId, ItemName\r\n\t| project TimeAdded, TimeDeleted, UserId, ItemName\r\n\t| extend timestamp = TimeAdded\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070353 - External users added and removed from Teams","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T12:39:57.7024547Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/95d09455-2a79-4d15-a8a8-bdfb0c726178","name":"95d09455-2a79-4d15-a8a8-bdfb0c726178","etag":"\"0500f4f5-0000-0d00-0000-62c0584c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n| extend PolicyAction=\"\" | extend Verdict=\"\"\r\n| where Operation==\"TIMailData\" and PolicyAction==\"NoAction\" and Verdict==\"Phish\"\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC040104 - Phishing detections not eliminated or blocked on O365","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T14:38:02.6211964Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/32b6422e-f112-4703-9d02-054bd829a032","name":"32b6422e-f112-4703-9d02-054bd829a032","etag":"\"05009afb-0000-0d00-0000-62c058b90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n| where (Operation==\"UpdateInboxRules\" or Operation==\"Forward\") | where OperationProperties[6].Value!=\"[]\" \r\n| where parse_json(tostring(OperationProperties[6].Value))[0].ActionType == \"Forward\"\r\n| where parse_json(tostring(parse_json(tostring(OperationProperties[6].Value))[0].Recipients))[0] !contains \"@mango.com\" \r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080210 - Forwarding to an external recipient by a user","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T14:39:52.5299302Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/32d0202b-3c96-4be7-afc5-47d851d7e377","name":"32d0202b-3c96-4be7-afc5-47d851d7e377","etag":"\"06009000-0000-0d00-0000-62c05c2e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \r\n| where (EventID == 4720 and (TargetUserName endswith \".Adm\" or TargetUserName endswith \".adm\" or TargetSid endswith \"-500\"))\r\n| extend AccountCustomEntity = TargetUserName\r\n| extend HostCustomEntity = Computer\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":" UC070107 - Admin user account created","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T14:54:37.7852882Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/8794d252-6a2e-4dcf-953a-0cc32dccb7f7","name":"8794d252-6a2e-4dcf-953a-0cc32dccb7f7","etag":"\"050098fc-0000-0d00-0000-62c059a50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").Netskope_CL\r\n| where ((useragent_s startswith \"Internet Explorer \" or useragent_s == \"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; InfoPath.2)\" or useragent_s == \"Mozilla/4.0 (compatible; Metasploit RSPEC)\" or useragent_s == \"Mozilla/4.0 (compatible; MSIE 6.1; Windows NT)\" or useragent_s == \"Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)\" or useragent_s == \"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0)\" or useragent_s == \"Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0)\" or useragent_s == \"Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Trident/4.0; SIMBAR={7DB0F6DE-8DE7-4841-9084-28FA914B0F2E}; SLCC1; .N\" or useragent_s == \"Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)\" or useragent_s == \"Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US) AppleWebKit/525.13 (KHTML, like Gecko) Chrome/4.0.221.6 Safari/525.13\" or useragent_s == \"Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; MAAU)\" or useragent_s == \"Mozilla/4.0 (compatible; SPIPE/1.0\" or useragent_s == \"Mozilla/5.0 (Windows NT 6.3; rv:39.0) Gecko/20100101 Firefox/35.0\" or useragent_s == \"Sametime Community Agent\" or useragent_s == \"X-FORWARDED-FOR\" or useragent_s == \"DotDotPwn v2.1\" or useragent_s == \"SIPDROID\" or useragent_s == \"Mozilla/5.0 (Windows NT 10.0; Win32; x32; rv:60.0)\" or useragent_s == \"Mozilla/6.0 (X11; Linux x86_64; rv:24.0) Gecko/20140205     Firefox/27.0 Iceweasel/25.3.0\" or useragent_s contains \"wordpress hash grabber\" or useragent_s contains \"exploit\"))\r\n| extend AccountCustomEntity = user_s\r\n| extend IPCustomEntity = srcip_s\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC010467 - Exploit Framework User Agent","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T14:43:49.1485796Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/5c5a53e4-ca44-4f82-b751-e0656e1b874f","name":"5c5a53e4-ca44-4f82-b751-e0656e1b874f","etag":"\"0500f8fc-0000-0d00-0000-62c059ef0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity | where (Operation == \"Remove-AuditConfigurationPolicy\")\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":" UC070209 - Suspicious Audit Configuration Policy Operations (via office365)","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T14:45:02.4770122Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/4bc92288-fd53-4e95-b166-084deb701f7b","name":"4bc92288-fd53-4e95-b166-084deb701f7b","etag":"\"6600f55a-0000-0d00-0000-62e242430000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n| where ((Operation == \"Add member to role\") and (ResultStatus == \"Success\") and (ModifiedProperties contains \"admin\"))\r\n| extend AccountCustomEntity = LogonUserDisplayName\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051306 - Add a User to an Admin Role (via office365)","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-28T08:01:06.169883Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/35eec3d0-427f-445a-9041-51bf43497b21","name":"35eec3d0-427f-445a-9041-51bf43497b21","etag":"\"9702dfd0-0000-0d00-0000-62bf07e10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog\r\n| where DeviceVendor == \"Trend Micro\" \r\n| where DeviceEventClassID == \"9002\" | where Message contains \"Quarantine Failed\"\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051683 - Malware detected and quarantine removed","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T14:42:40.7026944Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/911e298c-948c-4bc1-82e7-f3d1da513610","name":"911e298c-948c-4bc1-82e7-f3d1da513610","etag":"\"91028451-0000-0d00-0000-62bd9a3a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").Netskope_CL| where ((useragent_s contains \"(hydra)\" or useragent_s contains \" arachni/\" or useragent_s contains \" BFAC \" or useragent_s contains \" brutus \" or useragent_s contains \" cgichk \" or useragent_s contains \"core-project/1.0\" or useragent_s contains \" crimscanner/\" or useragent_s contains \"datacha0s\" or useragent_s contains \"dirbuster\" or useragent_s contains \"domino hunter\" or useragent_s contains \"dotdotpwn\" or useragent_s == \"FHScan Core\" or useragent_s contains \"floodgate\" or useragent_s contains \"get-minimal\" or useragent_s contains \"gootkit auto-rooter scanner\" or useragent_s contains \"grendel-scan\" or useragent_s contains \" inspath \" or useragent_s contains \"internet ninja\" or useragent_s contains \"jaascois\" or useragent_s contains \" zmeu \" or useragent_s contains \"masscan\" or useragent_s contains \" metis \" or useragent_s contains \"morfeus fucking scanner\" or useragent_s contains \"n-stealth\" or useragent_s contains \"nsauditor\" or useragent_s contains \"pmafind\" or useragent_s contains \"security scan\" or useragent_s contains \"springenwerk\" or useragent_s contains \"teh forest lobster\" or useragent_s contains \"toata dragostea\" or useragent_s contains \" vega/\" or useragent_s contains \"voideye\" or useragent_s contains \"webshag\" or useragent_s contains \"webvulnscan\" or useragent_s contains \" whcc/\" or useragent_s endswith \" Havij\" or useragent_s contains \"absinthe\" or useragent_s contains \"bsqlbf\" or useragent_s contains \"mysqloit\" or useragent_s contains \"pangolin\" or useragent_s contains \"sql power injector\" or useragent_s contains \"sqlmap\" or useragent_s contains \"sqlninja\" or useragent_s contains \"uil2pn\" or useragent_s == \"ruler\" or useragent_s == \"Mozilla/5.0 (Windows; U; Windows NT 5.1; pt-PT; rv:1.9.1.2) Gecko/20090729 Firefox/3.5.2 (.NET CLR 3.5.30729)\"))\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":" UC051407 - Hack Tool User Agent","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T12:42:33.632811Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/3b4443b1-b66a-4dd7-b524-167e1f305f8c","name":"3b4443b1-b66a-4dd7-b524-167e1f305f8c","etag":"\"0401cde0-0000-0d00-0000-636a1f4e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"P14D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let starttime = 14d;\nlet endtime = 8h;\nlet Mango = view () {\n    let historicalActivity =\n        workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SigninLogs\n        | where TimeGenerated between(ago(starttime) .. ago(endtime)) and ResultType == 0\n        | extend locationString = tostring(LocationDetails[\"state\"]) |where isnotempty(locationString)\n        | project TimeGenerated, AppDisplayName, UserPrincipalName, IPAddress, locationString;\n    let recentActivity = \n        workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SigninLogs\n        | where TimeGenerated > ago(endtime) and ResultType == 0\n        | extend locationString = tostring(LocationDetails[\"state\"]) |where isnotempty(locationString)\n        | project TimeGenerated, AppDisplayName, UserPrincipalName, IPAddress, locationString;\n    let RareLocation = recentActivity\n        | join kind= leftanti (historicalActivity) on locationString;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SigninLogs\n    | where TimeGenerated >= ago(endtime)\n        and ResultType == 0\n        and Identity !contains \"Tienda\" \n    | extend locationString = tostring(LocationDetails[\"state\"]) |where isnotempty(locationString)\n    | join kind= inner (RareLocation) on IPAddress\n    | summarize\n        by\n        IPAddress,\n        Identity,\n        UserId,\n        locationString,\n        TimeGenerated,\n        OperationName,\n        ResultType,\n        ResultDescription\n    | order by IPAddress asc, UserId asc\n    | extend AccountCustomEntity = Identity\n    | extend IPCustomEntity = IPAddress |where isnotempty(locationString)\n    | summarize arg_max(TimeGenerated, *) by IPAddress\n};\nunion withsource=\"TenantDetection\"  Mango\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC1586 - Suspicious AzureAD succesful signin","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-08T09:20:01.1283821Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/4b12514f-e307-46b9-98ab-14ae037df9d9","name":"4b12514f-e307-46b9-98ab-14ae037df9d9","etag":"\"0600530f-0000-0d00-0000-62c05f6b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nlet tor_ips = (\r\nexternaldata (tor_ip:string)\r\n[h@'https://raw.githubusercontent.com/SecOps-Institute/Tor-IP-Addresses/master/tor-exit-nodes.lst']);\r\ntor_ips\r\n | join ( workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").Netskope_CL  | where TimeGenerated > ago(1h) ) on $left.tor_ip == $right.dstip_s \r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC010904 - Tor network connection","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:08:26.8116762Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/ec0a4e78-c08c-49e2-99c0-6dbd8367fdf9","name":"ec0a4e78-c08c-49e2-99c0-6dbd8367fdf9","etag":"\"06008c0f-0000-0d00-0000-62c05fa30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nlet tor_ips = (\r\nexternaldata (tor_ip:string)\r\n[h@'https://raw.githubusercontent.com/SecOps-Institute/Tor-IP-Addresses/master/tor-exit-nodes.lst']);\r\ntor_ips\r\n | join ( workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").Netskope_CL  | where TimeGenerated > ago(1h) | where action_s == \"allow\" ) on $left.tor_ip == $right.srcip_s \r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC010945 - Inbound Tor network connection","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:09:20.8524213Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/7c2df67b-bb77-4c34-809e-a48b8703b771","name":"7c2df67b-bb77-4c34-809e-a48b8703b771","etag":"\"0600381d-0000-0d00-0000-62c0669b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SigninLogs\r\n| extend hour = datetime_part(\"hour\", TimeGenerated)\r\n| where hour !between (7 .. 21)\r\n| where  (UserPrincipalName contains \"admlucas\" or UserPrincipalName contains \"usat_06\" or UserPrincipalName contains \"usat_02\" or UserPrincipalName contains \"admrsanchez\" or UserPrincipalName contains \"AdmJaime\" or UserPrincipalName contains \"admremi\" or UserPrincipalName contains \"admomar\" or UserPrincipalName contains \"admjuanjo\" or UserPrincipalName contains \"admdmenendez\" or UserPrincipalName contains \"admaaliod\" or UserPrincipalName contains \"admpelayo\" or UserPrincipalName contains \"admmarcosp\" or UserPrincipalName contains \"admgon\" or UserPrincipalName contains \"admpako\" or UserPrincipalName contains \"MS_Tareas\" or UserPrincipalName contains \"admseneng\" or UserPrincipalName contains \"admioana\" or UserPrincipalName contains \"admmarta\" or UserPrincipalName contains \"admalexma\" or UserPrincipalName contains \"admsara\" or UserPrincipalName contains \"AdmJordi\" or UserPrincipalName contains \"admfer\" or UserPrincipalName contains \"admhector\" or UserPrincipalName contains \"admalex\" or UserPrincipalName contains \"admjeanlouis\" or UserPrincipalName contains \"admisaac\" or UserPrincipalName contains \"admoliver\" or UserPrincipalName contains \"admapuerto\" or UserPrincipalName contains \"admbcc\" or UserPrincipalName contains \"admalvaroallande\" or UserPrincipalName contains \"admlfagundez\" or UserPrincipalName contains \"AdmLivia\" or UserPrincipalName contains \"admfermalo\" or UserPrincipalName contains \"admmaite\" or UserPrincipalName contains \"admovila\" or UserPrincipalName contains \"admpocbmx\" or UserPrincipalName contains \"admrgarcia\" or UserPrincipalName contains \"admmarcosa\" or UserPrincipalName contains \"admjuanluis\" or UserPrincipalName contains \"00752640\" or UserPrincipalName contains \"admluciacamino\" or UserPrincipalName contains \"admjacastano\" or UserPrincipalName contains \"admmartaantuna\" or UserPrincipalName contains \"00752655\" or UserPrincipalName contains \"00752737\" or UserPrincipalName contains \"admrociobck\" or UserPrincipalName contains \"admnoemi\" or UserPrincipalName contains \"admcoral\" or UserPrincipalName contains \"MNG_Admin\") \r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070221 - Out of hours admin access","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:39:06.9981417Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/020f9226-3161-468b-9131-b0e6d433ae60","name":"020f9226-3161-468b-9131-b0e6d433ae60","etag":"\"8000ed63-0000-0d00-0000-6331ba690000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT10M","queryPeriod":"PT10M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\r\nlet UserId_exclusion = Mango_UC080234_exclusion_users | project UserId;\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where RecordType == \"SharePointFileOperation\" and Operation == \"FileAccessed\"\r\n    | where UserId !in (UserId_exclusion)\r\n    | summarize ['Number of Files Accesed']=dcount(SourceFileName), ['Files']=make_set(SourceFileName) by UserId\r\n    | where ['Number of Files Accesed'] >= 200\r\n\t};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080234 - Multiple Sharepoint files accessed in a short period","enabled":true,"description":"Detecta el acceso a múltiples archivos de sharepoint en un corto periodo de tiempo","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-26T14:42:35.6206643Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/deef2183-52d7-4d08-9161-2f8f0dc24341","name":"deef2183-52d7-4d08-9161-2f8f0dc24341","etag":"\"0f001ae2-0000-0d00-0000-62d113a80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SigninLogs \r\n    | where ResultType !in (\"50125\",\"50089\",\"50173\",\"500121\",\"50097\",\"70044\",\"50155\",\"50074\",\"50140\",\"50076\")\r\n    |summarize make_list(ResultType) by UserPrincipalName\r\n    |extend list_attempts = tostring(list_ResultType)\r\n    |extend list_attempts=replace_string(list_attempts,'\",\"',' ')\r\n    |extend list_attempts=replace_string(list_attempts,'[\"','')\r\n    |extend list_attempts=replace_string(list_attempts,'\"]','')\r\n    |where list_attempts matches regex @\"(\\d{2,}\\s){50,}0+\"\r\n    | project UserPrincipalName,list_attempts \r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050136 - Successful brute force attack","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-15T07:13:43.5760166Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/77d0777e-1523-4bbd-b8a2-d7fd6edcd3e6","name":"77d0777e-1523-4bbd-b8a2-d7fd6edcd3e6","etag":"\"06008f10-0000-0d00-0000-62c060340000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent | where (NewProcessName contains \"\\\\rundll32.exe\" and ((CommandLine contains \"FromBase64String\" or CommandLine contains \"RunHTMLApplication\" or CommandLine contains \"LaunchINFSection\" or CommandLine contains \"RegisterOCX\" or CommandLine contains \"OpenURL\" or CommandLine contains \"PrintHTML\" or CommandLine contains \"LaunchApplication\" or CommandLine contains \"InstallHinfSection\" or CommandLine contains \"SetupInfObjectInstallAction\" or CommandLine contains \"RouteTheCall\") or (CommandLine contains \"Control_RunDLL\" and CommandLine matches regex \"(?i).*shell32.dll.*.dll.*\") or (CommandLine contains \"ShellExec_RunDLL\" and CommandLine matches regex \"(?i).*rundll32.exe.*.exe.*\") or (CommandLine contains \"ShellExec_RunDLL\" and CommandLine matches regex \"(?i).*rundll32.exe.*.exe.*\")))\r\n| extend AccountCustomEntity = AccountName\r\n| extend HostCustomEntity = Computer\r\n| extend IPCustomEntity = IpAddress\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCS51437 - LOLBAS rundll32","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:11:48.2245256Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/749f4845-59e3-4488-bae8-8894f4fc77a4","name":"749f4845-59e3-4488-bae8-8894f4fc77a4","etag":"\"0600a710-0000-0d00-0000-62c0606f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"\r\nlet Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent | where (EventID == 4738 and (OldUacValue == \"0x10\") and (NewUacValue == \"0x210\")) \r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCS51021 - Suspicious Account Changes [Password Never Expires] (via audit)","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:12:46.6478903Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/f92b2565-2c12-4b48-bae6-f0ba81fd36e4","name":"f92b2565-2c12-4b48-bae6-f0ba81fd36e4","etag":"\"0600bc10-0000-0d00-0000-62c060b10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \r\n| where (EventID == 5145 and ShareName matches regex @\"\\\\\\\\.*\\\\SYSVOL\" and RelativeTargetName endswith \"ScheduledTasks.xml\" and AccessList contains \"4417\")\r\n| extend AccountCustomEntity = Account\r\n| extend HostCustomEntity = Computer\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC1122 - Persistence and Execution at scale via GPO scheduled task","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:13:52.5434761Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/d1368727-a958-4876-b70b-84d87e0737fd","name":"d1368727-a958-4876-b70b-84d87e0737fd","etag":"\"06002f18-0000-0d00-0000-62c063da0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 1102 and EventSourceName == \"Microsoft-Windows-Eventlog\" \r\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), EventCount = count() by Computer, Account, EventID, Activity\r\n| extend timestamp = StartTimeUtc, AccountCustomEntity = Account, HostCustomEntity = Computer\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080302 - Security Eventlog Cleared","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:27:22.0228002Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/a7e5f026-2294-457f-a2af-02466040cf13","name":"a7e5f026-2294-457f-a2af-02466040cf13","etag":"\"0600da10-0000-0d00-0000-62c0610d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent | where (EventID == \"4656\" and (ObjectType == \"SAM_DOMAIN\") and (ProcessName == \"lsass.exe\") and (AccessMask == \"0x705\"))\r\n| extend AccountCustomEntity = AccountName\r\n| extend HostCustomEntity = Computer\r\n| extend IPCustomEntity = IpAddress\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCS50561 - Possible LSASS memory access via Mimikatz lsadump or similar tool (via audit)","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:15:24.6097259Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/02ddcebc-75b2-4edb-ae0d-dfdf8032ea62","name":"02ddcebc-75b2-4edb-ae0d-dfdf8032ea62","etag":"\"06002212-0000-0d00-0000-62c061b20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent | where (CommandLine contains \"powershell\" and CommandLine contains \".DownloadFile\" and CommandLine contains \"System.Net.WebClient\")\r\n| extend AccountCustomEntity = AccountName\r\n| extend HostCustomEntity = Computer\r\n| extend IPCustomEntity = IpAddress\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCS51004 - PowerShell DownloadFile","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:18:09.859359Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/6ab25da7-e607-46ac-8b5f-eff5215a4824","name":"6ab25da7-e607-46ac-8b5f-eff5215a4824","etag":"\"00012bda-0000-0d00-0000-637f60e90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \r\n// Exclusion solicitada de los usuarios mng_qlik pertenecientes al dominio PAPPQLIKSENSE01 y IAPPQLIKSENSE01 por caso 755499\r\n| where (EventID == \"4625\" and Account !endswith \"$\" and (Account <> \"PAPPQLIKSENSE01\\\\mng_qlik\" and Account <> \"IAPPQLIKSENSE01\\\\mng_qlik\")) \r\n| summarize Agregate= count() by Account \r\n| where Agregate > 1000\r\n| extend AccountCustomEntity = Account\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050101 - Brute force login against existent accounts via event 4625","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-24T12:17:31.2648973Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/4d35ac6b-065a-4be0-b4e5-f776bb1b6908","name":"4d35ac6b-065a-4be0-b4e5-f776bb1b6908","etag":"\"90021d49-0000-0d00-0000-62bd5ebe0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent | where ((EventID == 5140 and ShareName == \"Admin$\") and not (SubjectUserName contains \"$\"))\r\n| extend AccountCustomEntity = AccountName\r\n| extend HostCustomEntity = Computer\r\n| extend IPCustomEntity = IpAddress\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCS50048 - Access to ADMIN$ Share.","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T08:28:45.2816785Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/94517642-5d07-4bca-b009-07d8f0466568","name":"94517642-5d07-4bca-b009-07d8f0466568","etag":"\"680069ea-0000-0d00-0000-62cd4b1b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \r\n| where (EventID == \"4624\" and ((SubjectUserSid == \"S-1-0-0\" and LogonType == \"3\" and LogonProcessName == \"NtLmSsp \" and KeyLength == \"0\") or (LogonType == \"9\" and LogonProcessName == \"seclogo\"))) and ((Account !contains \"ANONYMOUS LOGON\"))\r\n| where LmPackageName != \"NTLM V2\" \r\n| extend AccountCustomEntity = Account\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051203 - Pass the Hash Activity","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-12T10:21:13.0079422Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/b66c791a-a7ce-4093-8a6e-e56b3e0130cd","name":"b66c791a-a7ce-4093-8a6e-e56b3e0130cd","etag":"\"90028ea6-0000-0d00-0000-62bd73d80000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT10M","queryPeriod":"PT10M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let timeframe = 10m;\nlet threshold = 40;let Mango = view () {\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \n| where TimeGenerated >= ago(timeframe)\n| where EventID == 4625 and LogonType !in (3,4,5)\n| where AccountType =~ \"User\"\n| summarize min(TimeGenerated), max(TimeGenerated), FailedLogonCount = count() by EventID, Activity, WorkstationName, Account, \nTargetAccount, TargetUserName, TargetDomainName, LogonType, LogonTypeName, LogonProcessName, Status, SubStatus\n| where FailedLogonCount >= threshold\n| project StartTimeUtc = min_TimeGenerated, EndTimeUtc = max_TimeGenerated, FailedLogonCount, EventID, Activity, WorkstationName, \nAccount, TargetAccount, TargetUserName, TargetDomainName, LogonType, LogonTypeName, LogonProcessName, Status, SubStatus\n| extend timestamp = StartTimeUtc, AccountCustomEntity = Account, HostCustomEntity = WorkstationName\n};\nunion withsource=\"TenantDetection\"  Mango\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050137 - Failed login attempts in a short period of time","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T09:58:45.5178451Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/72e03011-0ea8-4f9b-88fd-56543b4d7bb9","name":"72e03011-0ea8-4f9b-88fd-56543b4d7bb9","etag":"\"3101d151-0000-0d00-0000-6384bcf60000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \r\n| where (EventID == \"4625\" and Account !endswith \"$\")  | where Account in (\"MNG\\\\03007038\",\"MNG\\\\03742234\",\"MNG\\\\56559924\",\"MNG\\\\03748018\",\"MNG\\\\03735117\",\"MNG\\\\03556186\",\"MNG\\\\56510425\",\"MNG\\\\03760023\",\"MNG\\\\03745464\",\"MNG\\\\03748126\",\"MNG\\\\03749831\",\"MNG\\\\56010112\")\r\n| summarize Agregate= count() by Account \r\n| where Agregate > 10\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050138 - Failed login attempts for VIP users","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-28T13:51:50.4310918Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/9daf5bda-df42-490e-a6a0-01397edd480d","name":"9daf5bda-df42-490e-a6a0-01397edd480d","etag":"\"9002cef8-0000-0d00-0000-62bd86a10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1DT6H","queryPeriod":"P1DT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \r\n| where EventID == \"4771\" and Status in (\"0x18\",\"0x12\") | where TargetAccount in (\"03007038\",\"03742234\",\"56559924\",\"03748018\",\"03735117\",\"03556186\",\"56510425\",\"03760023\",\"03745464\",\"03748126\",\"03749831\",\"56010112\") | summarize Agregate= count() by TargetAccount \r\n| where Agregate > 10};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050139 - Brute force login VIP user","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T11:18:56.9977384Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/e760da89-568e-435c-9f66-1b07b1eef98c","name":"e760da89-568e-435c-9f66-1b07b1eef98c","etag":"\"eb003ad4-0000-0d00-0000-6304a34e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    let VIPList = Mango_VIP_Users | project samAccountName;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4768\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName !in (VIPList) and isnotempty(samAccountName)\n    | where Status != \"0x0\"\n    | summarize occurrences = count() by tostring(samAccountName)\n    | where occurrences >= 100\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051684 - User TGT request error increase","enabled":true,"description":"Detects failed kerberos ticket request (Event ID 4768) on repeated occasions by a user who does not belong to the VIP list.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-08-23T09:51:57.3791691Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/41018a9e-b7a1-4faf-b5aa-fcc9292e0d0f","name":"41018a9e-b7a1-4faf-b5aa-fcc9292e0d0f","etag":"\"eb00554a-0000-0d00-0000-63049dec0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    let VIPList = Mango_VIP_Users | project samAccountName;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4768\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName in (VIPList) and isnotempty(samAccountName)\n    | where Status != \"0x0\"\n    | summarize occurrences = count() by tostring(samAccountName)\n    | where occurrences >= 45\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051685 - User TGT request error increase VIP","enabled":true,"description":"Detects failed kerberos ticket request (Event ID 4768) on repeated occasions by a user who does belong to the VIP list.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-08-23T09:28:57.4587762Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/e6ef5189-f4a0-4671-8f48-e1584ad8857b","name":"e6ef5189-f4a0-4671-8f48-e1584ad8857b","etag":"\"eb00469d-0000-0d00-0000-6304a0fe0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    let VIPList = Mango_VIP_Users | project samAccountName;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4769\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    | parse EventData with *'<Data Name=\"Status\">' Status '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName in (VIPList) and isnotempty(samAccountName)\n    | where Status != \"0x0\"\n    | summarize occurrences = count() by tostring(samAccountName)\n    | where occurrences >= 45\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051688 - User TGS request error increase VIP","enabled":true,"description":"Detects failed kerberos service request (event ID 4769) on repeated occasions by a user who does belong to the VIP list.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-08-23T09:42:02.3490726Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/fc7f669a-5de8-4d2b-a5fa-a4c834d652a9","name":"fc7f669a-5de8-4d2b-a5fa-a4c834d652a9","etag":"\"eb00d0bd-0000-0d00-0000-6304a27e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    let VIPList = Mango_VIP_Users | project samAccountName;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4769\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    | parse EventData with *'<Data Name=\"Status\">' Status '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName !in (VIPList) and isnotempty(samAccountName)\n    | where Status != \"0x0\"\n    | summarize occurrences = count() by tostring(samAccountName)\n    | where occurrences >= 100\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051689 - User TGS request error increase","enabled":true,"description":"Detects failed kerberos service request (event ID 4769) on repeated occasions by a user who does not belong to the VIP list.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-08-23T09:48:34.2991537Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/7430bfbc-3955-43e7-b660-715b3292adca","name":"7430bfbc-3955-43e7-b660-715b3292adca","etag":"\"a20019db-0000-0d00-0000-633305790000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    let DomainAdminsList = Mango_DomainAdmins | project samAccountName;\n    let VIPList = Mango_VIP_Users | project samAccountName;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4726\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName in (VIPList) or TargetUserName in~ (VIPList) or TargetUserName in~ (DomainAdminsList) and isnotempty(samAccountName)\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051690 - VIP user account deleted","enabled":true,"description":"Detects every time that a VIP user account is deleted.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-27T14:15:08.7757149Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/73b660cb-0aef-421b-a84f-80ccf89e5850","name":"73b660cb-0aef-421b-a84f-80ccf89e5850","etag":"\"d600dc8d-0000-0d00-0000-630337080000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    let DomainAdminsList = Mango_DomainAdmins | project samAccountName;\n    let SubjectUserNameExclusion = Mango_UC051691_exclusion_SubjectUserName | project SubjectUserName;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID in (4727, 4731, 4744, 4749, 4754, 4759)\n    // Extract SubjectUserName from RAW data because sometimes the field \"SubjectUserName\" comes empty\n    | parse EventData with *'\"SubjectUserName\">' SubjectUserName '</Data>'*\n    // If SubjectUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against Domain Admins lookup\n    | extend SubjectUserName = split(SubjectUserName,'\\\\')\n    | extend SubjectUserName = iff(array_length(SubjectUserName) > 1, SubjectUserName[1], SubjectUserName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend SubjectUserName = split(SubjectUserName,'@')[0]\n    | where SubjectUserName !in (DomainAdminsList) and isnotempty(SubjectUserName)\n    | where SubjectUserName !in (SubjectUserNameExclusion)\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051691 - Group creation by unauthorized user","enabled":true,"description":"Detects when an user who does not belong to Domain Admins group creates a group. Event IDs 4727, 4731, 4744, 4749, 4754, 4759.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-08-22T07:57:42.9154009Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/d06d73b4-418e-422b-aa09-9d16d887f993","name":"d06d73b4-418e-422b-aa09-9d16d887f993","etag":"\"91021a75-0000-0d00-0000-62bda2290000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4625 and IpPort in (range(1, 1023))\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051692 - Failed login from well-known port","enabled":true,"description":"Detects any failed login (Event ID 4625) from a well-known port (greater than 0 and less than 1024). Those ports should be system reserved and are not expected to be used to log in.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T13:16:24.9455349Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/40f55fb6-dac5-4f0d-83fa-edddb0d8ecf6","name":"40f55fb6-dac5-4f0d-83fa-edddb0d8ecf6","etag":"\"31026cfc-0000-0d00-0000-639b11790000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    let IpExclusion = Mango_UC051693_exclusion_IPAddress | project IpAddress;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4624 and IpPort in (range(1, 1023))\n    | where IpAddress !in (IpExclusion)\n    | where LogonType != 3\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051693 - Sucessful login from well-known port","enabled":true,"description":"Detects any successful login (Event ID 4624) from a well-known port (greater than 0 and less than 1024). Those ports should be system reserved and are not expected to be used to log in.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-15T12:21:56.4778931Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/982cd5bf-ff0b-4f4a-a1eb-51d40cc2945b","name":"982cd5bf-ff0b-4f4a-a1eb-51d40cc2945b","etag":"\"9102f578-0000-0d00-0000-62bda3150000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4769 and IpPort in (range(1, 1023))\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051694 - TGS request from well-known port","enabled":true,"description":"Detects any failed kerberos authentication request (Event ID 4769) from a well-known port (greater than 0 and less than 1024). Those ports should be system reserved and are not expected to be used to log in.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T13:20:19.245158Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/0bfc56ad-2f0e-4254-9b4c-b4d55b7bd1f2","name":"0bfc56ad-2f0e-4254-9b4c-b4d55b7bd1f2","etag":"\"91021d7a-0000-0d00-0000-62bda37f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4771 and IpPort in (range(1, 1023))\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051695 - Pre-authentication failed from well-known port","enabled":true,"description":"Detects any failed kerberos pre-authentication (Event ID 4771) from a well-known port (greater than 0 and less than 1024). Those ports should be system reserved and are not expected to be used to log in.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T13:22:06.9992471Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/8a273a4a-b3f1-4147-9075-9bc956b50700","name":"8a273a4a-b3f1-4147-9075-9bc956b50700","etag":"\"85006854-0000-0d00-0000-6390762c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4768 and IpPort in (range(1, 1023)) | where IpAddress !endswith \"192.168.50.177\"\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051696 - TGT request from well-known port","enabled":true,"description":"Detects any failed kerberos authentication request (Event ID 4768) from a well-known port (greater than 0 and less than 1024). Those ports should be system reserved and are not expected to be used to log in.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T11:16:48.4308402Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/8366d8b8-3179-46df-abeb-e6fcde4078cf","name":"8366d8b8-3179-46df-abeb-e6fcde4078cf","etag":"\"9102437d-0000-0d00-0000-62bda4850000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4719\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051697 - Policy audit changed","enabled":true,"description":"Detects that a computer's system level audit policy was modified (Event ID 4719).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T13:26:28.4246312Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/d2f1877d-756b-47ab-bafd-e98debdad0bf","name":"d2f1877d-756b-47ab-bafd-e98debdad0bf","etag":"\"91025781-0000-0d00-0000-62bda5470000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\n    let Blacklist = toscalar(Mango_Blacklist_ExecutableName | summarize make_set(MatchString));\n    let Events = workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4625 and (isnotnull(Process) and isnotempty(Process) and Process != \"-\");\n    Events\n    | mv-apply BlacklistMatch = Blacklist on (\n            where Process contains BlacklistMatch\n    )\n    | summarize occurrences = count() by tostring(Account), Process, tostring(BlacklistMatch)\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051698 - Restricted process name","enabled":true,"description":"Detects failed logins (Event ID 4625) where a process contains a restricted set of words (e.g, mimikatz or cain.exe) taken from a blacklist.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-06-30T13:29:42.4476152Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/4fe7aa3c-b6b7-4a0c-9c20-29c10c00e58f","name":"4fe7aa3c-b6b7-4a0c-9c20-29c10c00e58f","etag":"\"9602f006-0000-0d00-0000-62bea1a60000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    let VIPList = Mango_VIP_Users | project samAccountName;\n    let FailedEvents = workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4771 and Status !in (\"0x12\", \"0x13\", \"0x17\")\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName in (VIPList) and isnotempty(samAccountName)\n    | summarize FailedOccurrences = count() by tostring(samAccountName);\n    let SuccessEvents = workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4624\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName in (VIPList) and isnotempty(samAccountName)\n    | summarize SuccessOccurrences = count() by tostring(samAccountName);\n    SuccessEvents\n    | where samAccountName in ((FailedEvents | summarize make_list(samAccountName)))\n    | join FailedEvents on samAccountName\n    | project samAccountName, SuccessOccurrences, FailedOccurrences\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051686 - User pre-authentication failed error increase VIP","enabled":true,"description":"Detects kerberos pre-authentication failure (Event ID 4771) from users who does belong to the VIP list and the user account does not have revoked credentials, does not have any change to the account, the account is not locked out and has a correct login (Event ID 4624).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T07:26:26.9165192Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/21a86cb8-5572-4a37-8c17-78209bd51cc1","name":"21a86cb8-5572-4a37-8c17-78209bd51cc1","etag":"\"9602cf08-0000-0d00-0000-62bea2190000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    let VIPList = Mango_VIP_Users | project samAccountName;\n    let FailedEvents = workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4771 and Status !in (\"0x12\", \"0x13\", \"0x17\")\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName !in (VIPList) and isnotempty(samAccountName)\n    | summarize FailedOccurrences = count() by tostring(samAccountName);\n    let SuccessEvents = workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4624\n    // Extract TargetUserName from RAW data because sometimes the field \"Account\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against VIP lookup\n    | extend samAccountName = split(TargetUserName,'\\\\')\n    | extend samAccountName = iff(array_length(samAccountName) > 1, samAccountName[1], samAccountName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend samAccountName = split(samAccountName,'@')[0]\n    | where samAccountName !in (VIPList) and isnotempty(samAccountName)\n    | summarize SuccessOccurrences = count() by tostring(samAccountName);\n    SuccessEvents\n    | where samAccountName in ((FailedEvents | summarize make_list(samAccountName)))\n    | join FailedEvents on samAccountName\n    | project samAccountName, SuccessOccurrences, FailedOccurrences\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051687 - User pre-authentication failed error increase","enabled":true,"description":"Detects kerberos pre-authentication failure (Event ID 4771) from users who does not belong to the VIP list and the user account does not have revoked credentials, does not have any change to the account, the account is not locked out and has a correct login (Event ID 4624).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T07:28:24.7285682Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/0ce67f8a-647b-4d3b-b358-9f9a7baaaae1","name":"0ce67f8a-647b-4d3b-b358-9f9a7baaaae1","etag":"\"9602174b-0000-0d00-0000-62beb0fb0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").Netskope_CL\r\n| where useragent_s contains \"Microsoft BITS\" \r\n| where domain_s !endswith \".com\" and domain_s !endswith \".net\" and domain_s !endswith \".org\" and domain_s !endswith \"scdn.co\"\r\n| extend AccountCustomEntity = user_s\r\n| extend IPCustomEntity = srcip_s\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC1075 - Bitsadmin to Uncommon TLD","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T08:31:51.1781766Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/5cf60def-dea2-40ec-834f-84bc7f95ae06","name":"5cf60def-dea2-40ec-834f-84bc7f95ae06","etag":"\"9602e0e0-0000-0d00-0000-62bed14f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent | where CommandLine contains \"wevtutil cl\"\r\n| extend AccountCustomEntity = AccountName\r\n| extend HostCustomEntity = Computer\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080320 - Eventlog cleared","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T08:40:35.8029617Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/d83990ec-e25b-49ed-b036-828deeec901a","name":"d83990ec-e25b-49ed-b036-828deeec901a","etag":"\"96026565-0000-0d00-0000-62beb6bf0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P8D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let endtime = 1d;\nlet starttime = 8d;\nlet threshold = 2.0;let Mango = view () {\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n| where TimeGenerated >= ago(endtime) \n| where EventID == 4624 and LogonType == 10\n| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), ComputerCountToday = dcount(Computer), ComputerSet = makeset(Computer), ProcessSet = makeset(ProcessName)  \nby Account, IpAddress, AccountType, Activity, LogonTypeName\n| join (\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n| where TimeGenerated >= ago(starttime) and TimeGenerated < ago(endtime) \n| where EventID == 4624 and LogonType == 10\n| summarize ComputerCountPrev7Days = dcount(Computer) by Account, IpAddress\n) on Account, IpAddress\n| extend Ratio = ComputerCountToday/(ComputerCountPrev7Days*1.0)\n// Where the ratio of today to previous 7 days is more than double.\n| where Ratio > threshold\n| project StartTimeUtc, EndTimeUtc, Account, IpAddress, ComputerSet, ComputerCountToday, ComputerCountPrev7Days, Ratio, AccountType, Activity, LogonTypeName, ProcessSet\n| extend timestamp = StartTimeUtc, AccountCustomEntity = Account, IPCustomEntity = IpAddress\n};\nunion withsource=\"TenantDetection\"  Mango\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050236 - Multiple RDP connections from Single System","enabled":true,"description":"Identifies when an RDP connection is made to multiple systems and above the normal for the previous 7 days.  \nConnections from the same system with the same account within the same day.\nRDP connections are indicated by the EventID 4624 with LogonType = 10","alertRuleTemplateName":"78422ef2-62bf-48ca-9bab-72c69818a425","lastModifiedUtc":"2022-07-01T08:56:29.4052258Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/b4819ae6-1405-46d8-97b8-a6abf62cfd47","name":"b4819ae6-1405-46d8-97b8-a6abf62cfd47","etag":"\"6700a35a-0000-0d00-0000-62e25d620000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nlet AccountExclusion = Mango_UC080321_exclusion_users | project Account;\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 4730\r\n| where Account !in (AccountExclusion)\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080321 - Security global group deleted","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-28T09:56:49.6060892Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/43681553-0edc-436c-a6ac-4c1f60c6c436","name":"43681553-0edc-436c-a6ac-4c1f60c6c436","etag":"\"06002d13-0000-0d00-0000-62c0629a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5H","queryPeriod":"PT5H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == \"4728\" and TargetUserName in (\"Domain Admins\", \"Administrators\", \"Enterprise Admins\", \"Schema Admins\")\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCMA080301 - User added to a VIP group","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T15:22:01.9516296Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/bb892c05-ac3f-4a09-9d63-3ad5e5ca6372","name":"bb892c05-ac3f-4a09-9d63-3ad5e5ca6372","etag":"\"96022bc5-0000-0d00-0000-62becb530000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT12H","queryPeriod":"PT12H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {   \r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where Operation == \"Add-MailboxPermission\" and UserType != \"DcAdmin\"\r\n\t| extend SubjectUser = UserId\r\n\t| extend isnotnull(Parameters)\r\n\t| extend TargetUser = parse_json(parse_json(Parameters)[1]).Value \r\n\t| extend Mailbox = parse_json(parse_json(Parameters)[0]).Value\r\n\t| extend AccessRights = parse_json(parse_json(Parameters)[2]).Value\r\n\t| where AccessRights != \"FullAccess\"\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080504 - Add Mailbox Permission","enabled":true,"description":"Detección del añadido de permisos de un mailbox sobre una cuenta.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T10:24:18.6451871Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/11726ec0-8a3d-4aa3-80bb-084377381e8b","name":"11726ec0-8a3d-4aa3-80bb-084377381e8b","etag":"\"960236c9-0000-0d00-0000-62becc3c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT12H","queryPeriod":"PT12H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let timeframe=30m;\r\nlet threshold=3;   \r\nlet Mango = view () {    \r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where TimeGenerated > ago(1d)\r\n\t| where Operation == \"MemberRoleChanged\"\r\n\t| mv-expand Members\r\n\t| extend RoleAdded = tostring(Members.Role)\r\n\t| extend UserAdded = tostring(Members.UPN)\r\n\t| where RoleAdded == 2\r\n\t| project TimeGenerated, RoleAdded, UserAdded, TeamName, UserId\r\n\t| summarize Number_of_Teams_Made_Owner=dcount(TeamName), Team_Names=make_set(TeamName), UserWhoAdds=make_set(UserId) by UserAdded, bin(TimeGenerated, timeframe)\r\n\t| where Number_of_Teams_Made_Owner >= threshold\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070354 - User made owner of multiple Teams","enabled":true,"description":"User made owner of multiple Teams","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T10:28:10.8931046Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/ec531b4f-98db-4c7e-84e4-1e11e283e2e3","name":"ec531b4f-98db-4c7e-84e4-1e11e283e2e3","etag":"\"96028ecd-0000-0d00-0000-62becd120000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT2H","queryPeriod":"PT2H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {   \r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n    | where Operation == \"Add-MailboxPermission\" and UserType != \"DcAdmin\"\r\n  \t| extend SubjectUser = UserId\r\n    | extend TargetUser = parse_json(parse_json(Parameters)[1]).Value \r\n    | extend Mailbox = parse_json(parse_json(Parameters)[0]).Value\r\n    | extend AccessRights = parse_json(parse_json(Parameters)[2]).Value\r\n    | summarize NumGrantedPermissions = dcount(tostring(TargetUser)), UsersGrantedPermissions = make_set(tostring(TargetUser)) by SubjectUser, tostring(Mailbox)\r\n   \t| where NumGrantedPermissions >= 5\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080505 - Access Rights granted to multiple accounts","enabled":true,"description":"Detects Access Rights granted to multiple accounts from one single account.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T10:31:44.9180501Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/b05994c8-e79c-47dd-bb4f-2f3bdde74a27","name":"b05994c8-e79c-47dd-bb4f-2f3bdde74a27","etag":"\"0100219e-0000-0d00-0000-62eb72d10000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let starttime = ago(1d);\r\nlet endtime = now();\r\nlet lookback = starttime - 31d; \r\nlet historical_AppDistribution_mango = Mango_UC070355_exclusion_AppDistributionMode | project AppDistributionMode;\r\nlet Mango = view () {\r\n\tlet historical_addons_mango=(\r\n    \tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t\t| where TimeGenerated between(lookback..starttime)\r\n\t\t| where OfficeWorkload =~ \"MicrosoftTeams\"\r\n\t\t| where isnotempty(AddonName)\r\n\t\t| project AddonName);\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where TimeGenerated between(starttime..endtime)\r\n\t| where OfficeWorkload =~ \"MicrosoftTeams\" and Operation == \"AppInstalled\"\r\n\t| where isnotempty(AddonName)\r\n\t| where AddonName !in (historical_addons_mango)\r\n\t| where AppDistributionMode !in (historical_AppDistribution_mango)\r\n\t| extend timestamp = TimeGenerated, AccountCustomEntity = UserId\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070355 - New bot or application added to Teams","enabled":true,"description":"New bot or application added to Teams","alertRuleTemplateName":null,"lastModifiedUtc":"2022-08-04T07:18:29.6822011Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/d1abdf0b-9147-4361-9907-28d46d03a23a","name":"d1abdf0b-9147-4361-9907-28d46d03a23a","etag":"\"d3027534-0000-0d00-0000-637231f00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {  \r\n    let AccountExclusion = Mango_UC051699_exclusion_users | project UserId;\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where RecordType contains \"ExchangeAdmin\" and (UserId !contains \"NT AUTHORITY\\\\SYSTEM\" and UserId !contains \"Administrator\")\r\n    | extend localTime = datetime_utc_to_local(TimeGenerated, 'Europe/Madrid')\r\n\t| extend hour = datetime_part(\"hour\", localTime)\r\n\t| where hour !between (5 .. 19)\r\n    | where UserId !in (AccountExclusion)\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051699 - Exchange Actions outside working hours","enabled":true,"description":"Exchange Actions outside working hours","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-14T12:17:39.6328204Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/a568dc57-8b1a-423c-8f05-786f84f02040","name":"a568dc57-8b1a-423c-8f05-786f84f02040","etag":"\"960269d6-0000-0d00-0000-62becf090000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {   \r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n    | where (Operation contains \"MailboxPermission\")\r\n    | extend TargetUser = parse_json(parse_json(Item).ParentFolder).MemberUpn\r\n    | extend TargetFolder = parse_json(parse_json(Item).ParentFolder).Name\r\n    | where isnotnull(MailboxOwnerUPN) and isnotempty(MailboxOwnerUPN)\r\n    | where TargetUser != MailboxOwnerUPN and UserId != UserKey\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080506 - Permissions added to other account","enabled":true,"description":"Permissions added to other account","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T10:40:08.6475826Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/f4f830b8-a643-4954-bf78-a010341d0bb5","name":"f4f830b8-a643-4954-bf78-a010341d0bb5","etag":"\"7e0053cf-0000-0d00-0000-6331872a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    let ExclusionList = Mango_UC080507_exclusion_users\n        | project SubjectUser;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\n    | where Operation == \"Add-MailboxPermission\" and UserType != \"DcAdmin\"\n    | extend SubjectUser = UserId\n    | extend isnotnull(Parameters)\n    | extend TargetUser = parse_json(parse_json(Parameters)[1]).Value \n    | extend Mailbox = parse_json(parse_json(Parameters)[0]).Value\n    | extend AccessRights = parse_json(parse_json(Parameters)[2]).Value\n    | where AccessRights == \"FullAccess\"\t\n    | where SubjectUser !in (ExclusionList)\n};\nunion withsource=\"TenantDetection\"  Mango\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080507 - FullAccess granted on a Mailbox","enabled":true,"description":"FullAccess granted on a Mailbox","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-26T11:03:58.1939868Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/70aa9348-3724-4211-9b0d-47b0180c8e1e","name":"70aa9348-3724-4211-9b0d-47b0180c8e1e","etag":"\"960262dd-0000-0d00-0000-62bed06c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {   \r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where RecordType == \"SharePointFileOperation\" and Operation == \"FileAccessed\"\r\n\t| where UserId contains \"#ext#\"\r\n\t| summarize ['Number of Files Accesed']=dcount(SourceFileName), ['Files Accesed']=make_set(SourceFileName) by UserId\r\n\t| where ['Number of Files Accesed'] >= 50\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080508 - External user accessed multiple Sharepoint files","enabled":true,"description":"External user accessed multiple Sharepoint files","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T10:46:03.6856738Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/10cbd6dc-9dcf-4514-b2fd-7f7cbcc49816","name":"10cbd6dc-9dcf-4514-b2fd-7f7cbcc49816","etag":"\"960290f9-0000-0d00-0000-62bed6f30000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").AWSCloudTrail | where EventName == \"ConsoleLogin\" \r\n| where UserIdentityPrincipalid endswith \"root\" \r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050239 - Cloudtrail root ConsoleLogin","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T11:13:54.54067Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/07c4fb41-bcaf-463e-8856-7badfcfe25ae","name":"07c4fb41-bcaf-463e-8856-7badfcfe25ae","etag":"\"97020931-0000-0d00-0000-62bee43c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").AWSCloudTrail | where EventSource =~ 'rds.amazonaws.com' and EventName =~ 'ModifyDBInstance' \r\n| where parse_json(tostring(parse_json(ResponseElements).pendingModifiedValues.masterUserPassword)) contains @\"\\\"\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050240 - AWS RDS Master Password Change ","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T12:10:34.7422086Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/66ea33fb-e3dc-4463-872d-a7ccb1dbf0f3","name":"66ea33fb-e3dc-4463-872d-a7ccb1dbf0f3","etag":"\"5f00684a-0000-0d00-0000-632c45260000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT30M","queryPeriod":"PT30M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"//Variables\r\nlet ExcludeIPs = \"172.29.65.100\";\r\nlet Mango = view () {   \r\n \tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog \r\n    | where DeviceVendor == \"Fortinet\" or DeviceVendor == \"Palo Alto Networks\"\r\n    | where ipv4_is_private(SourceIP) and not(ipv4_is_private(DestinationIP))\r\n    | summarize NumDistinctIPs = dcount(DestinationIP), DestinationIPs = make_set(DestinationIP) by SourceIP, DeviceVendor\r\n    | where NumDistinctIPs >= 850 \r\n    | where SourceIP !in (ExcludeIPs)\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC060328 - Outbound IPv4 network scan","enabled":true,"description":"Searches private IP addresses with connections to a big amount of public IPs.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-22T11:20:58.416535Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/1c7fba43-69de-41d7-bd91-d03aad1a693f","name":"1c7fba43-69de-41d7-bd91-d03aad1a693f","etag":"\"970296e1-0000-0d00-0000-62bf0ba00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4624 and LogonType == 10\n    | extend PrivateIP = ipv4_is_private(IpAddress)\n    | where PrivateIP == false\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050233 - Successful RDP login from a public IP","enabled":true,"description":"Detects an RDP connection from a public IP (Event ID 4624 with logon type 10).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T14:58:38.9303954Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/6433af9a-d600-4df7-a3c7-d628b6aef1cf","name":"6433af9a-d600-4df7-a3c7-d628b6aef1cf","etag":"\"3102d123-0000-0d00-0000-639b0de70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").AWSCloudTrail\r\n| where EventName == \"ConsoleLogin\"\r\n| extend LoginResult = tostring(parse_json(ResponseElements).ConsoleLogin) \r\n| where LoginResult <> \"Success\" | extend range_exclusion = (ipv4_is_match(SourceIpAddress, '5.252.104.0/22')) | where range_exclusion != true | summarize count() by UserIdentityArn, SourceIpAddress | where count_ >= 3\r\n| where isnotempty(UserIdentityArn)\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050140 - Bruteforce detected in Cloudtrail","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-15T12:06:46.4997219Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/0ec66e20-2edd-4237-ab39-768dcb1b934b","name":"0ec66e20-2edd-4237-ab39-768dcb1b934b","etag":"\"9802741d-0000-0d00-0000-62bf19700000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog \n\t| where DeviceVendor == \"Thycotic Software\" and Activity == \"ROLE - ASSIGNUSERORGROUP\" and (FileName == \"MANGO_Administrator\" or FileName == \"Privileged_Administrator\" or FileName == \"Administrator\")\n    | extend User = DeviceCustomString2\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCMA050901 - PAM assigned role with privileged permissions","enabled":true,"description":"Asignación de permisos privilegiados \"MANGO_Administrator\", \"Privileged_Administrator\" o \"Administrator\" a un usuario de PAM.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T15:57:35.5168574Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/a311c7d1-869c-4dcd-9eae-7ea41392b445","name":"a311c7d1-869c-4dcd-9eae-7ea41392b445","etag":"\"9802751f-0000-0d00-0000-62bf19f00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog \n\t| where DeviceVendor == \"Thycotic Software\" and (SourceUserName contains \"bga_pmp\" or DestinationUserName contains \"bga_pmp\")\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCMA050201 - PAM BGA_pmp user related activity","enabled":true,"description":"Actividad del usuario BGA_bmp. Este usuario no se utiliza salvo ocasiones muy especiales y contadas. Debe ser consultada siempre la legitimidad de las acciones con el cliente.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T15:59:43.819109Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/a8dfd28a-9884-4206-b9e5-466ea9db83de","name":"a8dfd28a-9884-4206-b9e5-466ea9db83de","etag":"\"11002300-0000-0d00-0000-62d15a2a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog \n    | where DeviceVendor == \"Thycotic Software\"\n    | where SourceUserName != \"ThycoticSystem\" // Solicitado por el cliente detección - 693094 \n        and Activity contains \"USER\"\n        and (Activity contains \"EDIT\" or Activity contains \"CREATE\" or Activity contains \"DISABLE\" or Activity contains \"REMOVE\" or Activity contains \"DELETE\")\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070133 - PAM User administration actions","enabled":true,"description":"Borrado, edición o creación de usuarios en PAM.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-15T12:14:32.9193644Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/7e555c66-f9ab-4996-a151-a6e5de735ee3","name":"7e555c66-f9ab-4996-a151-a6e5de735ee3","etag":"\"9802b566-0000-0d00-0000-62bf2a040000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let timeframe = 1h;\r\nlet Mango = view () {\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog \r\n\t| where (DeviceVendor == \"Fortinet\" or DeviceVendor == \"Palo Alto Networks\") and (isnotnull(SentBytes) and isnotempty(SentBytes))\r\n\t| where not(ipv4_is_private(SourceIP)) and not(ipv4_is_private(DestinationIP))\r\n\t| summarize bytes_totales = sum(SentBytes) by SourceIP, DestinationIP, bin(TimeGenerated, timeframe)\r\n\t| where (bytes_totales > 10000000000)\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080232 - Abnormal outbound data volume (connection initiated by public source)","enabled":true,"description":"Monitors unusual volume of outgoing data started by a public IP.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T17:08:19.0833159Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/ed528a05-9560-490a-9af6-b6cfe6139e5f","name":"ed528a05-9560-490a-9af6-b6cfe6139e5f","etag":"\"8f004c20-0000-0d00-0000-62fcc6a90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let timeframe = 1h;\r\nlet Mango = view () {\r\n    let DestinationIPExclusion = Mango_UC080233_exclusion_destinatioip | project DestinationIP;\r\n    let SourceIPExclusion = Mango_UC080233_exclusion_SourceIP | project SourceIP;\r\n    let SAMUserExclusion = Mango_UC080233_exclusion_samaccountname_2 | project samaccountname;\r\n    let SAMUserExclusion_wetransfer_downloading = Mango_UC080233_exclusion_samaccountname_userprincipalname | project samaccountname;\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog \r\n\t| where (DeviceVendor == \"Fortinet\" or DeviceVendor == \"Palo Alto Networks\") and (isnotnull(SentBytes) and isnotempty(SentBytes))\r\n\t| where ipv4_is_private(SourceIP) and not(ipv4_is_private(DestinationIP))\r\n\t| where DestinationIP !in (DestinationIPExclusion)\r\n    | where SourceIP !in (SourceIPExclusion)\r\n    | where SourceUserName !in (SAMUserExclusion)\r\n\t| where ApplicationProtocol != \"wetransfer-downloading\" and SourceUserName !in (SAMUserExclusion_wetransfer_downloading)\r\n\t| summarize SentBytes = sum(SentBytes), ReceivedBytes = sum(ReceivedBytes) by SourceIP, DestinationIP, bin(TimeGenerated, timeframe)\r\n\t| where (SentBytes > 10000000000)\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080233 - Abnormal outbound data volume (connection initiated by private source)","enabled":true,"description":"Monitors unusual volume of outgoing data started by a private IP.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-08-17T10:44:41.6296226Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/65065686-4b39-4cc3-9ebb-beca60ceb05a","name":"65065686-4b39-4cc3-9ebb-beca60ceb05a","etag":"\"02004d33-0000-0d00-0000-62ebd56a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {   \r\n   \tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog  \r\n   \t| where DeviceVendor == \"Fortinet\" or DeviceVendor == \"Palo Alto Networks\"\r\n   \t| where ipv4_is_private(SourceIP) and not(ipv4_is_private(DestinationIP))\r\n   \t| summarize NumDistinctDestinationPorts = dcount(DestinationPort), NumDistinctApps = dcount(ApplicationProtocol), DestinationPorts = make_set(DestinationPort) by SourceIP, DestinationIP, DeviceVendor\r\n \t| where NumDistinctDestinationPorts >= 500 and NumDistinctApps >= 10\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC060329 - Outbound IPv4 port scan","enabled":true,"description":"Searches for connection attempts from private IPs to several ports on the same public IP.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-08-04T14:19:07.4674869Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/53ac9c6d-5483-4c79-bb45-fa1e4ed4a526","name":"53ac9c6d-5483-4c79-bb45-fa1e4ed4a526","etag":"\"9802056e-0000-0d00-0000-62bf2b860000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {   \r\n   \tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog  \r\n \t| where DeviceVendor == \"Fortinet\" or DeviceVendor == \"Palo Alto Networks\"\r\n   \t| where not(ipv4_is_private(SourceIP)) and ipv4_is_private(DestinationIP)\r\n    | where DeviceAction in (\"pass\",\"allow\")\r\n   \t| summarize NumDistinctDestinationPorts = dcount(DestinationPort), DestinationPorts = make_set(DestinationPort) by SourceIP, DestinationIP, DeviceVendor\r\n   \t| where NumDistinctDestinationPorts >= 500 \r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC060330 - Inbound IPv4 accepted port scan","enabled":true,"description":"Searches for connection attempts from public IPs to several ports on the same private IP.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T17:14:45.7673448Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/1f50f20f-ac93-414a-a2f0-320d59e4c9ea","name":"1f50f20f-ac93-414a-a2f0-320d59e4c9ea","etag":"\"98022671-0000-0d00-0000-62bf2be90000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog   \r\n\t| where isnotempty(MaliciousIP) and MaliciousIP == SourceIP\r\n\t| where not(ipv4_is_private(DestinationIP)) and ipv4_is_private(SourceIP)\r\n\t| where DeviceAction == \"allow\"\r\n\t| summarize count() by SourceIP, DestinationIP, MaliciousIP\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC010946 - Inbound accepted suspicious TI IPv4 connection","enabled":true,"description":"Searches for connections from public IP tagged as suspicious to private IP.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T17:16:23.0057141Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/45577a4f-a240-4c6e-9228-264536bc4130","name":"45577a4f-a240-4c6e-9228-264536bc4130","etag":"\"e1015ada-0000-0d00-0000-6346adff0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog   \r\n\t| where isnotempty(MaliciousIP) and MaliciousIP == DestinationIP\r\n\t| where not(ipv4_is_private(DestinationIP)) and ipv4_is_private(SourceIP)\r\n\t| summarize count() by SourceIP, DestinationIP, MaliciousIP\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC010947 - Outbound suspicious TI IPv4 connection","enabled":true,"description":"Searches for connections from private IP addresses to public IP tagged as suspicious.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-12T12:07:07.3225201Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/5932953c-da68-425d-a642-13129b02f464","name":"5932953c-da68-425d-a642-13129b02f464","etag":"\"98025994-0000-0d00-0000-62bf33550000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").AWSCloudTrail   \r\n    | where EventName == \"ConsoleLogin\"\r\n    | summarize NumIps = dcount(SourceIpAddress), IPs = make_set(SourceIpAddress) by UserIdentityPrincipalid \r\n    | where NumIps > 1\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050241 - Cloudtrail user login from multiple IPs","enabled":true,"description":"Detects logins of a user accout from multiple IPs","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T17:48:03.3800445Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/5e052f1f-8ca8-44b3-a639-28c472fc9749","name":"5e052f1f-8ca8-44b3-a639-28c472fc9749","etag":"\"c2021b5d-0000-0d00-0000-62bf56350000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CylancePROTECT\r\n    | where EventType == \"Threat\" and EventName == \"threat_found\"\r\n\t| where Status in (\"Unsafe\",\"Abnormal\")\r\n\t| summarize by DeviceName, FileName, FilePath, FileType, Status\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC011101 - Not Cleared or Quarantined Threat","enabled":true,"description":"An alert is triggered always that a file is not quarantined, cleared (deleted) or waived (excluded).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T20:16:51.4493306Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/11102527-10fb-408b-9cf5-0a04bbb66676","name":"11102527-10fb-408b-9cf5-0a04bbb66676","etag":"\"6600e442-0000-0d00-0000-62cbf24c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P7D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let starttime = ago(1h);\r\nlet endtime = now();\r\nlet lookback = starttime - 7d;\r\nlet Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CylancePROTECT\r\n    | where TimeGenerated between(lookback..starttime)\r\n    | where EventType == \"ExploitAttempt\" and EventName == \"blocked\"\r\n    | parse SyslogMessage with *\"Action:\" ExploitAction \",\"*\r\n    | parse SyslogMessage with *\"Process Name: \" ExploitProcessName \",\"*\r\n    | parse SyslogMessage with *\"User Name: \" ExploitUserName \",\"*\r\n    | parse SyslogMessage with *\"Violation Type: \" ExploitViolationType \",\"*\r\n    | summarize alerts_last_week = count() by EventType, ExploitProcessName, DeviceName, ExploitUserName, ExploitViolationType\r\n    | join kind=inner (\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CylancePROTECT\r\n    | where TimeGenerated between(starttime..endtime)\r\n    | where EventType == \"ExploitAttempt\" and EventName == \"blocked\"\r\n    | parse SyslogMessage with *\"Action:\" ExploitAction \",\"*\r\n    | parse SyslogMessage with *\"Process Name: \" ExploitProcessName \",\"*\r\n    | parse SyslogMessage with *\"User Name: \" ExploitUserName \",\"*\r\n    | parse SyslogMessage with *\"Violation Type: \" ExploitViolationType \",\"*\r\n    | summarize alerts_today = count() by EventType, ExploitProcessName, DeviceName, ExploitUserName, ExploitViolationType\r\n    ) on ExploitProcessName, DeviceName\r\n    | summarize by EventType, ExploitProcessName, DeviceName, ExploitUserName, ExploitViolationType, alerts_last_week, alerts_today\r\n    | where alerts_last_week + alerts_today >= 10\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC011102 - Recurrent exploit attempt on device","enabled":true,"description":"This use case monitors recurrent low severity detections of activities flagged as exploit attempts by CylanceProtect for the same device.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-11T09:50:03.316134Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/3ba08861-706d-41b9-baab-e3d13dc824c0","name":"3ba08861-706d-41b9-baab-e3d13dc824c0","etag":"\"c2026c66-0000-0d00-0000-62bf570b0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CylancePROTECT\r\n    | where EventType == \"ExploitAttempt\" and EventName == \"none\"\r\n    | parse SyslogMessage with *\"Action:\" ExploitAction \",\"*\r\n    | parse SyslogMessage with *\"Process Name: \" ExploitProcessName \",\"*\r\n    | parse SyslogMessage with *\"User Name: \" ExploitUserName \",\"*\r\n    | parse SyslogMessage with *\"Violation Type: \" ExploitViolationType \",\"*\r\n    | summarize count() by EventType, ExploitProcessName, DeviceName, ExploitUserName, ExploitViolationType\r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC011103 - Exploit attempt not blocked notable events","enabled":true,"description":"This use case monitors supicious behaviors flagged as exploit attempts by CylanceProtect","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-01T20:20:25.3037178Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/b584c659-c240-441a-a4a6-d0b75bd8f1e3","name":"b584c659-c240-441a-a4a6-d0b75bd8f1e3","etag":"\"66003e9e-0000-0d00-0000-62e2477f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    let ruleNameExclusion = Mango_UCMA051101_exclusion | project ruleName_s;\r\n    let subRuleNameExclusion = Mango_UCMA051101_exclusion | project subRuleName_s;\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_OAT_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_RCA_Result_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_RCA_Task_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_WORKBENCH_CL\r\n    | where ruleId_d between (1000000 .. 1999999) and Severity == 8 \r\n    | where ruleName_s !in (ruleNameExclusion)\r\n    | where subRuleName_s !in (subRuleNameExclusion)\r\n\t| summarize by endpoint_name_s, endpoint_ips_s, ruleName_s, subRuleName_s, Severity \r\n};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCMA051101 - Trend Micro High severity signature not blocked","enabled":true,"description":"Detects IPS intrusions that are classified as high severity and are not blocked, with signatureID between 1,000,000 and 1,999,999 (Trend Micro IPS rule), the signature ID is the same as the IPS rule ID.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-28T08:23:26.3483196Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/3d05c720-48d0-4095-8f8a-b5c40e27cbb7","name":"3d05c720-48d0-4095-8f8a-b5c40e27cbb7","etag":"\"2d0070e2-0000-0d00-0000-62d53fc50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT2H","queryPeriod":"PT2H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CylancePROTECT\r\n    | where EventType == \"ScriptControl\" and EventName == \"Blocked\" and FilePath !endswith(\".vba\")\r\n    | summarize NumDistinctHosts = dcount(DeviceName), Hosts = make_set(DeviceName) by FilePath\r\n    | where NumDistinctHosts >= 50\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC011104 - Recurrent script blocked across organization","enabled":true,"description":"This use case monitors recurrent blocked script executions (macros ignored) on multiple devices within the organization.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-18T11:11:00.500865Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/6bf0ce86-790a-47f9-aaa2-4169533f8b57","name":"6bf0ce86-790a-47f9-aaa2-4169533f8b57","etag":"\"0500bb7e-0000-0d00-0000-62c038c00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_OAT_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_RCA_Result_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_RCA_Task_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_WORKBENCH_CL\r\n    | where ruleId_d between (1000000 .. 1999999)\r\n    | where ipv4_is_private(src_s) and not(ipv4_is_private(dst_s))\r\n};\r\nunion withsource=\"TenantDetection\" Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Impact"],"displayName":"UC070132 - Outbound IPv4 Intrusion Detected rule TrendMicro","enabled":true,"description":"Detects possible intrusions from a public destination IPv4 to a private source IPv4 that are not blocked, with signatureID between 1,000,000 and 1,999,999 (Trend Micro IPS rule), the signature ID is the same as the IPS rule ID.\n","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T12:23:25.4463995Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/b79c16ed-fe9f-4e93-8aaa-1d07f9cadc58","name":"b79c16ed-fe9f-4e93-8aaa-1d07f9cadc58","etag":"\"05007f80-0000-0d00-0000-62c039650000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_OAT_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_RCA_Result_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_RCA_Task_CL\r\n    | union workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").TrendMicro_XDR_WORKBENCH_CL\r\n    | where ruleId_d between (1000000 .. 1999999)\r\n    | where ipv4_is_private(dst_s) and not(ipv4_is_private(src_s)) \r\n};\r\nunion withsource=\"TenantDetection\" Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Impact"],"displayName":"UC070134 - Inbound IPv4 Intrusion Detected rule TrendMicro","enabled":true,"description":"Detects possible intrusions from a public source IPv4 to a private destination IPv4 that are not blocked, with signatureID between 1,000,000 and 1,999,999 (Trend Micro IPS rule), the signature ID is the same as the IPS rule ID.\n","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T12:26:11.1506932Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/ce399322-0822-4809-9c5a-bbc7d207b5a1","name":"ce399322-0822-4809-9c5a-bbc7d207b5a1","etag":"\"0500c0d6-0000-0d00-0000-62c04beb0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4769\n    | parse EventData with *'IpAddress\">' IpAddress '<'*\n    | where IpAddress != \"-\" and isnotnull(IpAddress) and isnotempty(IpAddress)\n    | parse EventData with *'Status\">' Status '<'*\n    | where Status =~ \"0x6\"\n    | parse EventData with *'TargetUserName\">' TargetUserName '<'*\n    | where TargetUserName != \"-\" and isnotnull(TargetUserName) and isnotempty(TargetUserName)\n    | summarize Count = count() by IpAddress, TargetUserName\n    | summarize DistinctTargetedAccounts = count() by SourceIpAddress = IpAddress\n    | where DistinctTargetedAccounts >= 10\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050144 - ST Possible user enumeration","enabled":true,"description":"Detects multiple kerberos ST (Service Ticket) requests of different users from the same IP with an incorrect or bad user name (non-existent) on several repeated occasions (Event ID 4769, Status 0x6).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T13:45:12.8582553Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/d9aba2dc-9154-40e0-ac4e-26d3e9885e3e","name":"d9aba2dc-9154-40e0-ac4e-26d3e9885e3e","etag":"\"6101a4f1-0000-0d00-0000-6311ab3c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    let SourceIPExclusion = MANGO_UC050145_exclusion_SourceIP | project SourceIP;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4768\n    | parse EventData with *'IpAddress\">' IpAddress '<'*\n    | where IpAddress != \"-\" and isnotnull(IpAddress) and isnotempty(IpAddress)\n    | parse EventData with *'Status\">' Status '<'*\n    | where Status =~ \"0x6\"\n    | parse EventData with *'TargetUserName\">' TargetUserName '<'*\n    | where TargetUserName != \"-\" and isnotnull(TargetUserName) and isnotempty(TargetUserName)\n    | where IpAddress !in (SourceIPExclusion)\n    | summarize Count = count() by IpAddress, TargetUserName\n    | summarize DistinctTargetedAccounts = count() by SourceIpAddress = IpAddress\n    | where DistinctTargetedAccounts >= 10\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050145 - TGT Possible user enumeration","enabled":true,"description":"Detects multiple kerberos TGT requests of different users from the same IP with an incorrect or bad user name (non-existent) on several repeated occasions (Event ID 4768, Status 0x6).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-02T07:05:19.8421671Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/599dd8c8-25b0-41ef-98ba-42cb76cb22b5","name":"599dd8c8-25b0-41ef-98ba-42cb76cb22b5","etag":"\"050006e1-0000-0d00-0000-62c04ece0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT6H","queryPeriod":"PT6H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").CommonSecurityLog\n\t| where DeviceVendor == \"Trend Micro\"\n\t| where Activity == \"Offline\"\n\t| parse AdditionalExtensions with \"target=\" computer \";\"*\n\t| parse Message with *\"since \" OfflineDate \". The Agent\"*\n\t| parse OfflineDate with month \" \" day \", \" year \" \"hour\n\t| extend month = iff(month=='January',1,iff(month=='February',2,iff(month=='March',3,iff(month=='April',4,iff(month=='May',5,iff(month=='June',6,iff(month=='July',7,iff(month=='August',8,iff(month=='September',9,iff(month=='October',10,iff(month=='November',11,iff(month=='December',12,0))))))))))))\n\t| extend OfflineDate = strcat(year,\"-\",month,\"-\",day,\" \",hour)\n\t| extend DaysOffline = datetime_diff('day',now(),todatetime(OfflineDate))\n\t| where DaysOffline > 6\n\t| summarize by computer,DaysOffline\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC030302 - TrendMicro XDR agent offline for too long","enabled":true,"description":"Agente de Trend Micro XDR que lleva demasiados días en estado offline.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T13:57:33.6562557Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/57412e59-79a1-44e4-9071-dce5c32b8183","name":"57412e59-79a1-44e4-9071-dce5c32b8183","etag":"\"0200dd2a-0000-0d00-0000-62d90ac00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\n    let DomainAdminsList = Mango_DomainAdmins | project samAccountName;\n    let DataAdminList = Mango_DataAdmins | project SubjectUserName;\n    let User_Exclusion = Mango_UC070135_exclusion_users | project SubjectUserSid;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4720 and SubjectUserName !in (DomainAdminsList)\n    | where EventID == 4720 and SubjectUserName !in (DataAdminList)\n    | where SubjectUserSid !in (User_Exclusion)\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070135 - Unauthorized account creation","enabled":true,"description":"This event is generated every time a new account object is created by a user which is not in the allowed admin user list. Also the event is generated on domain controllers, member servers and workstations. (Event ID 4720)","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-21T08:13:50.80058Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/3d528098-d13b-4fa2-a8fd-cfc69e075650","name":"3d528098-d13b-4fa2-a8fd-cfc69e075650","etag":"\"a3007103-0000-0d00-0000-633312fa0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\n    let DomainAdminsList = Mango_DomainAdmins | project samAccountName;\n    let VIPList = Mango_VIP_Users | project samAccountName;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4725\n    // Extract TargetUserName from RAW data because sometimes the field \"TargetUserName\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against lookup\n    | extend TargetUserName = split(TargetUserName,'\\\\')\n    | extend TargetUserName = iff(array_length(TargetUserName) > 1, TargetUserName[1], TargetUserName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend TargetUserName = split(TargetUserName,'@')[0]\n    | where TargetUserName in~ (DomainAdminsList) or TargetUserName in~ (VIPList)\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080323 - VIP user account disabled","enabled":true,"description":"Triggers always that a user in the VIP or Domain Admin list is disabled (Event ID 4725).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-27T15:12:47.7023543Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/f021dd15-2f4d-4dd0-b85f-89d2ccd966f2","name":"f021dd15-2f4d-4dd0-b85f-89d2ccd966f2","etag":"\"0600909e-0000-0d00-0000-62c089300000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let IP_Data = IPv4_Country_Ranges;\nlet Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").AWSCloudTrail\n    | where EventName == \"ConsoleLogin\"\n    | where not(ipv4_is_private(SourceIpAddress))\n    | where UserIdentityArn contains \"dmin\"\n    | evaluate ipv4_lookup(IP_Data, SourceIpAddress, network, return_unmatched = true)\n    | summarize count() by SourceIpAddress, country_iso_code, UserIdentityPrincipalid, UserIdentityArn\n    | where country_iso_code != \"ES\"\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070222 - CloudTrail AWS Admin console login from outside Spain","enabled":true,"description":"Autenticación en la consola de AWS con un usuario con permisos de administración desde una dirección IP no perteneciente a España.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T18:06:38.8039099Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/ea7bacb4-d82d-47c9-a6f6-31523e05ecd6","name":"ea7bacb4-d82d-47c9-a6f6-31523e05ecd6","etag":"\"06001fa5-0000-0d00-0000-62c089da0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let IP_Data = IPv4_Country_Ranges;\nlet Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").AWSCloudTrail\n    | where EventName == \"CreateUser\" and UserIdentityType == \"IAMUser\"\n    | where not(ipv4_is_private(SourceIpAddress))\n    | evaluate ipv4_lookup(IP_Data, SourceIpAddress, network, return_unmatched = true)\n    | summarize count() by SourceIpAddress, country_iso_code, UserIdentityPrincipalid, UserIdentityArn\n    | where country_iso_code != \"ES\"\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050965 - CloudTrail AWS IAM user creation from outside Spain","enabled":true,"description":"Creación de un usuario IAM en AWS desde una dirección IP de fuera de España.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T18:09:29.7773752Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/fe1a622e-32d2-4911-bb92-473495e72523","name":"fe1a622e-32d2-4911-bb92-473495e72523","etag":"\"060050b9-0000-0d00-0000-62c095e40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT15M","queryPeriod":"PT15M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    let DomainAdminsList = Mango_DomainAdmins | project samAccountName;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID == 4781\n    // Extract TargetUserName from RAW data because sometimes the field \"TargetUserName\" comes empty\n    | parse EventData with *'\"TargetUserName\">' TargetUserName '</Data>'*\n    // If TargetUserName contains the domain (like CLIENT\\user_name), we'll keep only the username to be able to check it against lookup\n    | extend TargetUserName = split(TargetUserName,'\\\\')\n    | extend TargetUserName = iff(array_length(TargetUserName) > 1, TargetUserName[1], TargetUserName[0])\n    // We do the same removing @CLIENT.DOMAIN\n    | extend TargetUserName = split(TargetUserName,'@')[0]\n    | where TargetUserName in~ (DomainAdminsList)\n};\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080322 - VIP user account name changed","enabled":true,"description":"Login account of user in administrators list has been changed (Event ID 4781).","alertRuleTemplateName":null,"lastModifiedUtc":"2022-07-02T19:00:50.8158884Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/e165eefc-0512-491c-97f6-ed4299a42a94","name":"e165eefc-0512-491c-97f6-ed4299a42a94","etag":"\"1000a890-0000-0d00-0000-62d142b20000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Low","query":"union isfuzzy=true \n(\n SecurityEvent\n | where EventID == 4738\n | where SubjectAccount !contains \"usat\"\n // 2089 value indicates the Don't Expire Password value has been set\n | where UserAccountControl has \"%%2089\" \n | extend Value_2089 = iff(UserAccountControl has \"%%2089\",\"'Don't Expire Password' - Enabled\", \"Not Changed\")\n // 2050 indicates that the Password Not Required value is NOT set, this often shows up at the same time as a 2089 and is the recommended value.  This value may not be in the event. \n | extend Value_2050 = iff(UserAccountControl has \"%%2050\",\"'Password Not Required' - Disabled\", \"Not Changed\")\n // If value %%2082 is present in the 4738 event, this indicates the account has been configured to logon WITHOUT a password. Generally you should only see this value when an account is created and only in Event 4720: Account Creation Event.  \n | extend Value_2082 = iff(UserAccountControl has \"%%2082\",\"'Password Not Required' - Enabled\", \"Not Changed\")\n | project StartTime = TimeGenerated, EventID, Activity, Computer, TargetAccount, TargetSid, AccountType, UserAccountControl, Value_2089, Value_2050, Value_2082, SubjectAccount\n | extend timestamp = StartTime, AccountCustomEntity = TargetAccount, HostCustomEntity = Computer\n ),\n (\n WindowsEvent\n | where EventID == 4738 and EventData has '2089'\n // 2089 value indicates the Don't Expire Password value has been set\n | extend UserAccountControl = tostring(EventData.UserAccountControl)\n | where UserAccountControl has \"%%2089\" \n | extend Value_2089 = iff(UserAccountControl has \"%%2089\",\"'Don't Expire Password' - Enabled\", \"Not Changed\")\n // 2050 indicates that the Password Not Required value is NOT set, this often shows up at the same time as a 2089 and is the recommended value.  This value may not be in the event. \n | extend Value_2050 = iff(UserAccountControl has \"%%2050\",\"'Password Not Required' - Disabled\", \"Not Changed\")\n // If value %%2082 is present in the 4738 event, this indicates the account has been configured to logon WITHOUT a password. Generally you should only see this value when an account is created and only in Event 4720: Account Creation Event.  \n | extend Value_2082 = iff(UserAccountControl has \"%%2082\",\"'Password Not Required' - Enabled\", \"Not Changed\")\n | extend Activity=\"4738 - A user account was changed.\"\n | extend TargetAccount = strcat(EventData.TargetDomainName,\"\\\\\", EventData.TargetUserName)\n | extend TargetSid = tostring(EventData.TargetSid)\n | extend SubjectAccount = strcat(EventData.SubjectDomainName,\"\\\\\", EventData.SubjectUserName)\n | extend SubjectUserSid = tostring(EventData.SubjectUserSid)\n | extend AccountType=case(SubjectAccount endswith \"$\" or SubjectUserSid in (\"S-1-5-18\", \"S-1-5-19\", \"S-1-5-20\"), \"Machine\", isempty(SubjectUserSid), \"\", \"User\")\n | project StartTime = TimeGenerated, EventID, Activity, Computer, TargetAccount, TargetSid, AccountType, UserAccountControl, Value_2089, Value_2050, Value_2082, SubjectAccount\n | extend timestamp = StartTime, AccountCustomEntity = TargetAccount, HostCustomEntity = Computer\n )","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Persistence"],"displayName":"AD account with Don't Expire Password","enabled":true,"description":"Identifies whenever a user account has the setting \"Password Never Expires\" in the user account properties selected.\nThis is indicated in Security event 4738 in the EventData item labeled UserAccountControl with an included value of %%2089.\n%%2089 resolves to \"Don't Expire Password - Enabled\".","alertRuleTemplateName":"6c360107-f3ee-4b91-9f43-f4cfd90441cf","lastModifiedUtc":"2022-07-15T09:31:17.4006231Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/6b840143-d61b-4e26-985b-b05df6d0c224","name":"6b840143-d61b-4e26-985b-b05df6d0c224","etag":"\"c3088f47-0000-0d00-0000-631ef3600000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"P1D","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let logonDiff = 5s;\r\nlet Mango = view () {\r\nlet aadSignin = \r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SigninLogs\r\n| where ResultType == \"0\" \r\n| where AppDisplayName !in (\"Office 365 Exchange Online\", \"Skype for Business Online\")\r\n| project SuccessLogonTime = TimeGenerated, UserPrincipalName, SuccessIPAddress = IPAddress, AppDisplayName, SuccessIPBlock = strcat(split(IPAddress, \".\")[0], \".\", split(IPAddress, \".\")[1]), Type\r\n| join kind= inner (\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SigninLogs\r\n    | where ResultType !in (\"0\", \"50140\") \r\n    | where ResultDescription !~ \"Other\"  \r\n    | where AppDisplayName !in (\"Office 365 Exchange Online\", \"Skype for Business Online\")\r\n    | project FailedLogonTime = TimeGenerated, UserPrincipalName, FailedIPAddress = IPAddress, AppDisplayName, ResultType, ResultDescription, Type\r\n) on UserPrincipalName, AppDisplayName \r\n| where SuccessLogonTime < FailedLogonTime and FailedLogonTime - SuccessLogonTime <= logonDiff and FailedIPAddress !startswith SuccessIPBlock\r\n| summarize FailedLogonTime = max(FailedLogonTime), SuccessLogonTime = max(SuccessLogonTime) by UserPrincipalName, SuccessIPAddress, AppDisplayName, FailedIPAddress, ResultType, ResultDescription, Type\r\n| extend timestamp = SuccessLogonTime;\r\nlet aadNonInt = \r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").AADNonInteractiveUserSignInLogs\r\n| where ResultType == \"0\" \r\n| where AppDisplayName !in (\"Office 365 Exchange Online\", \"Skype for Business Online\")\r\n| project SuccessLogonTime = TimeGenerated, UserPrincipalName, SuccessIPAddress = IPAddress, AppDisplayName, SuccessIPBlock = strcat(split(IPAddress, \".\")[0], \".\", split(IPAddress, \".\")[1]), Type\r\n| join kind= inner (\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").AADNonInteractiveUserSignInLogs\r\n    | where ResultType !in (\"0\", \"50140\") \r\n    | where ResultDescription !~ \"Other\"  \r\n    | where AppDisplayName !in (\"Office 365 Exchange Online\", \"Skype for Business Online\")\r\n    | project FailedLogonTime = TimeGenerated, UserPrincipalName, FailedIPAddress = IPAddress, AppDisplayName, ResultType, ResultDescription, Type\r\n) on UserPrincipalName, AppDisplayName \r\n| where SuccessLogonTime < FailedLogonTime and FailedLogonTime - SuccessLogonTime <= logonDiff and FailedIPAddress !startswith SuccessIPBlock\r\n| summarize FailedLogonTime = max(FailedLogonTime), SuccessLogonTime = max(SuccessLogonTime) by UserPrincipalName, SuccessIPAddress, AppDisplayName, FailedIPAddress, ResultType, ResultDescription, Type\r\n| extend timestamp = SuccessLogonTime;\r\nunion isfuzzy=true aadSignin, aadNonInt\r\n};\r\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["CredentialAccess","InitialAccess"],"displayName":"UCMA050202 - Successful logon from IP and failure from a different IP","enabled":true,"description":"Identifies when a user account successfully logs onto an Azure App from one IP and within 5 seconds failed to logon to the same App via a different IP.\nThis may indicate a malicious attempt at password guessing based on knowledge of the users account.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-12T08:52:20.8332262Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/ff92445c-8d15-4e54-a042-671b2b63d18c","name":"ff92445c-8d15-4e54-a042-671b2b63d18c","etag":"\"9d004aa3-0000-0d00-0000-6332da5e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"PT5M","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"//Variables\r\nlet AddEvents = dynamic ([4732, 4728, 4756, 4746, 4751, 4761]);\r\nlet RemoveEvents = dynamic ([4733, 4729, 4757, 4747, 4752, 4762]);\r\nlet AdminsGroups = Mango_UC051292_AdminsGroups | project TargetUserName;\r\nlet Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID in (AddEvents) or EventID in (RemoveEvents)\r\n| where TargetUserName in (AdminsGroups)\r\n| summarize by TimeGenerated, Computer, SubjectUserName,ModifiedGroup = TargetUserName, ModifiedUser = MemberName, EventID, Activity\r\n| order by TimeGenerated desc\r\n};\r\nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051326 - Modification in membership of domain administrator groups","enabled":true,"description":"Modification of domain administrator group memberships","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-27T11:11:16.0697545Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/75124352-fb77-455c-a215-019c7a7f4cf6","name":"75124352-fb77-455c-a215-019c7a7f4cf6","etag":"\"6a029669-0000-0d00-0000-636d1c790000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SAP\r\n| where Message matches regex \"User .* created\" and not(UserName matches regex \"CUA_*\")\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Persistence"],"displayName":"AUTO DISABLED UC050967 - SAP User Creation","enabled":false,"description":"The alert rule was disabled due to too many consecutive failures. Reason: Semantic error occurred while running the query. Try resetting the alert rule by clicking edit, and save. User creation detected in SAP","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-10T15:44:57.0799656Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/333689ad-4002-4196-af24-6ae429bd1916","name":"333689ad-4002-4196-af24-6ae429bd1916","etag":"\"6a021c89-0000-0d00-0000-636d1cb70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SAP\r\n| where Message matches regex \"User .* deleted\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Impact","Persistence"],"displayName":"AUTO DISABLED UC050968 - SAP User Deleted","enabled":false,"description":"The alert rule was disabled due to too many consecutive failures. Reason: Semantic error occurred while running the query. Try resetting the alert rule by clicking edit, and save. User deleted detected in SAP","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-10T15:45:59.0151771Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/df469525-2693-4f4f-a60f-1480431c53ad","name":"df469525-2693-4f4f-a60f-1480431c53ad","etag":"\"6a02f9d3-0000-0d00-0000-636d1d9e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let Mango = view () {\nlet AccountException = Mango_UC050969_exclusion_usersallowed | project sap_user;\nlet AccountExceptionV = Mango_UC050969_exclusion_usersallowedV | project sap_user;\nlet AccountExceptionF = Mango_UC050969_exclusion_usersallowedF | project sap_user;\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SAP\n    | where Message matches regex \"Authorizations for user .* changed\" and not( UserName matches regex \"CUA_*\" or UserName in (AccountException) or (UserName in (AccountExceptionV) and sap_data_var1 matches regex \"V_*\") or (UserName in (AccountExceptionF) and sap_data_var1 matches regex \"F_*\"))\n}; \nunion withsource=\"TenantDetection\"  Mango\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Impact","Persistence"],"displayName":"AUTO DISABLED UC050969 - SAP Authorizations for user changed","enabled":false,"description":"The alert rule was disabled due to too many consecutive failures. Reason: Semantic error occurred while running the query. Try resetting the alert rule by clicking edit, and save. Authorizations for user changed detected in SAP","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-10T15:49:50.6740956Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/82b9aa7d-5bf4-430a-8cd9-d6abec5e99f2","name":"82b9aa7d-5bf4-430a-8cd9-d6abec5e99f2","etag":"\"6a0269f1-0000-0d00-0000-636d1dec0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SAP\r\n| where Message matches regex \"Profile .* deleted\" or Message matches regex \"Profile .* changed\" or Message matches regex \"Profile .* created\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Impact","Persistence"],"displayName":"AUTO DISABLED UC050970 - SAP Profile Changed","enabled":false,"description":"The alert rule was disabled due to too many consecutive failures. Reason: Semantic error occurred while running the query. Try resetting the alert rule by clicking edit, and save.  Change of a profile detected in SAP","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-10T15:51:08.0212829Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/d9a41cf7-a5a5-4455-a045-f63f746c72df","name":"d9a41cf7-a5a5-4455-a045-f63f746c72df","etag":"\"6c021c24-0000-0d00-0000-636d205a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SAP\r\n| where Message matches regex \"Authorization .* created\" and not( UserName matches regex \"CUA_*\")\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Persistence"],"displayName":"AUTO DISABLED UC050971 - SAP Authorization Created","enabled":false,"description":"The alert rule was disabled due to too many consecutive failures. Reason: Semantic error occurred while running the query. Try resetting the alert rule by clicking edit, and save. Authorization created for an user detected in SAP","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-10T16:01:30.5382676Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/6edfadb4-c5ae-4c0a-bf22-b0a6b82c8f6e","name":"6edfadb4-c5ae-4c0a-bf22-b0a6b82c8f6e","etag":"\"6c02ba90-0000-0d00-0000-636d21580000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SAP\r\n| where Message matches regex \"Authorization .* deleted\" and not( UserName matches regex \"CUA_*\")\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":["Impact"],"displayName":"AUTO DISABLED UC050972 - SAP Authorization deleted","enabled":false,"description":"The alert rule was disabled due to too many consecutive failures. Reason: Semantic error occurred while running the query. Try resetting the alert rule by clicking edit, and save. Authorization deleted for an user detected in SAP","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-10T16:05:44.3906599Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/c698be57-9036-4d13-b140-692138baae15","name":"c698be57-9036-4d13-b140-692138baae15","etag":"\"b20007c2-0000-0d00-0000-6336e5c70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \r\n| where (EventID == 501 and EventData contains '/eku')\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070139 - AD FS Detection EKU Object Identifier Attribute Abnormal ","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-30T12:48:59.9325001Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/21cb1001-1881-4f9f-b30f-4fffa4f6462d","name":"21cb1001-1881-4f9f-b30f-4fffa4f6462d","etag":"\"8100c72f-0000-0d00-0000-6357b6420000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent \r\n| where (EventID == 307)\r\n| extend EventDataString = tostring(EventData)\r\n|extend user = extract_all(\"<Data>(.*?)</Data>\", EventDataString) \r\n| where user[2] != \"MNG\\\\MS_Tareas\"}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070140 - ADFS Trust Modification Detection ","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-25T10:10:59.1396398Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/41ffb84f-17fb-435a-92e7-4895b02ff8ae","name":"41ffb84f-17fb-435a-92e7-4895b02ff8ae","etag":"\"b200e1c9-0000-0d00-0000-6336e7d60000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID in (\"1204\",\"405\")\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070141 - Password Change in AD FS","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-30T12:57:45.7172617Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/3748f4aa-5fbc-498b-ac2f-ee566a5797f5","name":"3748f4aa-5fbc-498b-ac2f-ee566a5797f5","etag":"\"b20098d4-0000-0d00-0000-6336e90f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent| where EventID in (\"1205\",\"406\") | summarize count() by Account | where count_ >= 5\n\n}; \nunion withsource=\"TenantDetection\"  Mango\n\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070142 - Multiple Password Change Request Error","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-30T13:02:58.8913623Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/8538e681-6803-4de4-b2a6-653781d4ff40","name":"8538e681-6803-4de4-b2a6-653781d4ff40","etag":"\"9502c7d4-0000-0d00-0000-636e35940000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 1202 | extend username = extract_all(@\"UserId&gt;(.*)&lt;/UserId&gt;\",EventData) \r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050249 - Credential Validation Success","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-11T11:44:20.0038365Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/01840d21-33fa-48b5-a579-7ccc40d90c9b","name":"01840d21-33fa-48b5-a579-7ccc40d90c9b","etag":"\"7000282f-0000-0d00-0000-63566d0e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n    | where EventID == 1203\r\n    | extend d=parse_xml(EventData)\r\n    | extend resul = tostring(d.EventData.Data[1])\r\n    | extend ip = tostring(d.EventData.Data[4])\r\n    | extend user = extract_all(\"<UserId>(.*?)<\", resul)[0]\r\n    | summarize count() by tostring(user) \r\n    | where count_ >= 1000\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050250 - Credential Validation Error","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-24T10:46:23.4957342Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/233791b4-5314-471f-b4d5-252473deb36e","name":"233791b4-5314-471f-b4d5-252473deb36e","etag":"\"b2008ed8-0000-0d00-0000-6336ea4f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 342 \r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050251 - Token validation failed","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-30T13:08:17.7749905Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/629ba03d-1364-4441-acf2-1db4e5752299","name":"629ba03d-1364-4441-acf2-1db4e5752299","etag":"\"c2002891-0000-0d00-0000-6364f7210000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 412 and SourceComputerId!=\"27374d7a-3eb7-4d74-b5d7-92cbbf652162\" and SourceComputerId!=\"3391c566-b142-478a-ab99-38f08a3d12dd\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC050252 - Token validation Success","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-04T11:27:14.1220431Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/da798fd7-8bc0-4a20-a038-1cc777064230","name":"da798fd7-8bc0-4a20-a038-1cc777064230","etag":"\"b200b1e3-0000-0d00-0000-6336ed2d0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 309\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070143 - Wmi Configuration Change Success","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-09-30T13:20:34.4163777Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/115178ce-8e1e-4cd7-8ff8-6e30c4951def","name":"115178ce-8e1e-4cd7-8ff8-6e30c4951def","etag":"\"c200cec6-0000-0d00-0000-6365107a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\n    | where EventID in (\"1210\")\n    | extend d=parse_xml(EventData)\n    | extend resul = tostring(d.EventData.Data[1])\n    | extend ip = extract_all(\"<IpAddress>(.*?)<\", resul)[0]\n    | extend userId = extract_all(\"<UserId>(.*?)<\", resul)[0]\n    | extend CurrentBadPasswordCount = extract_all(\"<CurrentBadPasswordCount>(.*?)<\", resul)[0]\n    | extend ConfigBadPasswordCount = extract_all(\"<ConfigBadPasswordCount>(.*?)<\", resul)[0]\n    | extend Endpoint = extract_all(\"<Endpoint>(.*?)<\", resul)[0]\n    | where CurrentBadPasswordCount >= 2000\n    | where not (ip == \"192.168.16.5\")\n}; \nunion withsource=\"TenantDetection\"  Mango\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070144 - Extranet lockout","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-04T13:15:24.9039683Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/b0a340e4-0038-462f-ab37-1c40f8c0fd6f","name":"b0a340e4-0038-462f-ab37-1c40f8c0fd6f","etag":"\"90001b09-0000-0d00-0000-6358f4930000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let PrimerUmbralWarning = 50 ;\nlet SegundoUmbralCritical = 150 ;\nlet Mango = view () {\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").Usage\n| where TimeGenerated >= ago(24h) \n| where IsBillable == true\n| summarize TotalVolumeGB = sum(Quantity) / 1000 by bin(StartTime, 1d), DataType\n| summarize Media_consumo_total_GB = round(avg(TotalVolumeGB), 2) by DataType\n| summarize Total_Daily_Consuption_Average_GBD = round(sum(Media_consumo_total_GB),2)\n| extend alerta = iff(Total_Daily_Consuption_Average_GBD > PrimerUmbralWarning, strcat('Detecctada anomalia en recoleccion, superando umbral de advertencia ', PrimerUmbralWarning, \" GBD\"), iff(Total_Daily_Consuption_Average_GBD > SegundoUmbralCritical, strcat('Detecctada anomalia en recoleccion, superando umbral critico: ', SegundoUmbralCritical, ' GBD [Recoleccion Suspendida]'),strcat(\"Recoleccion dentro de parametros normales , la media actual diaria: \",Total_Daily_Consuption_Average_GBD, \" GBD\"))) \n};\nMango\n| where Total_Daily_Consuption_Average_GBD > SegundoUmbralCritical\n| project TenantDetection = \"Mango\", Total_Daily_Consuption_Average_GBD, alerta","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"VOL-SEN-001 - Daily Cap critical consumption","enabled":true,"description":"Log Analytics Workspace Daily Cap critical consumption exceeded ","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-26T08:49:22.3445225Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/e82196ee-b532-4e8e-a701-3a664afca01a","name":"e82196ee-b532-4e8e-a701-3a664afca01a","etag":"\"06010ac5-0000-0d00-0000-63621ae60000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let PrimerUmbralWarning = 65 ;\nlet SegundoUmbralCritical = 150 ;\nlet Mango = view () {\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").Usage\n| where TimeGenerated >= ago(24h) \n| where IsBillable == true\n| summarize TotalVolumeGB = sum(Quantity) / 1000 by bin(StartTime, 1d), DataType\n| summarize Media_consumo_total_GB = round(avg(TotalVolumeGB), 2) by DataType\n| summarize Total_Daily_Consuption_Average_GBD = round(sum(Media_consumo_total_GB),2)\n| extend alerta = iff(Total_Daily_Consuption_Average_GBD > PrimerUmbralWarning, strcat('Detecctada anomalia en recoleccion, superando umbral de advertencia ', PrimerUmbralWarning, \" GBD\"), iff(Total_Daily_Consuption_Average_GBD > SegundoUmbralCritical, strcat('Detecctada anomalia en recoleccion, superando umbral critico: ', SegundoUmbralCritical, ' GBD [Recoleccion Suspendida]'),strcat(\"Recoleccion dentro de parametros normales , la media actual diaria: \",Total_Daily_Consuption_Average_GBD, \" GBD\"))) \n};\nMango\n| where Total_Daily_Consuption_Average_GBD > PrimerUmbralWarning\n| project TenantDetection = \"Mango\", Total_Daily_Consuption_Average_GBD, alerta","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"VOL-SEN-002 - Daily Cap warning consumption","enabled":true,"description":"Log Analytics Workspace Daily Cap warning consumption exceeded ","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-02T07:23:17.4788511Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/2116771c-25a0-454d-970e-da79ee4b7377","name":"2116771c-25a0-454d-970e-da79ee4b7377","etag":"\"8e00e8ff-0000-0d00-0000-63909ebc0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProductName == \"Microsoft 365 Defender\"\n        and AlertSeverity == \"High\"\n        and Status in (\"New\")\n}; \nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051671 - 365 Defender High Severity Alert Detection","enabled":true,"description":"365 Defender High Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T14:09:49.445232Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/ad03fc9d-3578-41b6-a8ce-8d1b84aae5b0","name":"ad03fc9d-3578-41b6-a8ce-8d1b84aae5b0","etag":"\"8f00341b-0000-0d00-0000-63909f440000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProductName == \"Microsoft 365 Defender\"\n        and AlertSeverity == \"Medium\"\n        and Status in (\"New\")\n}; \nunion withsource=\"TenantDetection\"  Mango\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051670 - 365 Defender Medium Severity Alert Detection","enabled":true,"description":"365 Defender Medium Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T14:12:01.1282079Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/eace3055-ab02-4e32-9e49-dcc9bc20a954","name":"eace3055-ab02-4e32-9e49-dcc9bc20a954","etag":"\"be008aa2-0000-0d00-0000-633af65e0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT4H","queryPeriod":"PT4H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").OfficeActivity\r\n\t| where (Operation==\"UpdateInboxRules\" or Operation==\"Forward\") | where OperationProperties[6].Value!=\"[]\" \r\n\t| where OperationProperties contains \"@\"\r\n\t| where parse_json(tostring(OperationProperties[6].Value))[0].ActionType == \"Forward\"\r\n\t| where parse_json(tostring(parse_json(tostring(OperationProperties[6].Value))[0].Recipients))[0] contains \"@mango.com\"\r\n\t| summarize [\"Número de cuentas internas a las que se hizo redirección\"] = dcount(tostring(parse_json(tostring(parse_json(tostring(OperationProperties[6].Value))[0].Recipients))[0])), [\"Cuentas internas a las que se hizo redirección\"] = make_set(tostring(parse_json(tostring(parse_json(tostring(OperationProperties[6].Value))[0].Recipients))[0])) by UserId\r\n\t| where [\"Número de cuentas internas a las que se hizo redirección\"] >= 2\r\n\t};\r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC080509 - Mailbox Redirection to 2 or more internal mailboxes","enabled":true,"description":"Mailbox Redirection to 2 or more internal mailboxes","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-03T14:48:50.3321233Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/8284353d-9f38-4ccc-a8af-a68ae9b3ce02","name":"8284353d-9f38-4ccc-a8af-a68ae9b3ce02","etag":"\"c300f18a-0000-0d00-0000-633c56970000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 308\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070145 - Configuration change failure","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-04T15:51:40.3845532Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/501f8324-1082-4d30-a547-487b51b372d2","name":"501f8324-1082-4d30-a547-487b51b372d2","etag":"\"c300a296-0000-0d00-0000-633c5a100000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 310 | summarize count() by Account | where count_ >= 3\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070146 - Multiple failed changes in wmi configuration","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-04T16:06:26.7869169Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/7907b1d0-9acf-44e5-800f-d8a122b8fddc","name":"7907b1d0-9acf-44e5-800f-d8a122b8fddc","etag":"\"c3005499-0000-0d00-0000-633c5ad40000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 407 | summarize count() by Computer | where count_ >= 3\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070147 - Multiple failed password change","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-04T16:09:45.2638701Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/19c88e2d-af91-4f3e-90b6-d801692ac65e","name":"19c88e2d-af91-4f3e-90b6-d801692ac65e","etag":"\"c300fda5-0000-0d00-0000-633c5f230000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 207 | summarize count() by Computer | where count_ >= 3\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070149 - Multiple failures writing to audit log","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-04T16:28:06.9062288Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/8cd09ddd-68f3-4aca-b4ae-dffc9d9c4c14","name":"8cd09ddd-68f3-4aca-b4ae-dffc9d9c4c14","etag":"\"c300fcb0-0000-0d00-0000-633c61440000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\nworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityEvent\r\n| where EventID == 103\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC070150 - AD FS Service stop","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-04T16:37:03.0841808Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/968c7bad-fcbb-460f-8187-781b7e83b022","name":"968c7bad-fcbb-460f-8187-781b7e83b022","etag":"\"9000f077-0000-0d00-0000-6390a5b70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProductName == \"Azure Active Directory Identity Protection\"\n and AlertSeverity == \"High\" and Status in (\"New\")\n};\nunion withsource=\"TenantDetection\"  Mango\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051712 - Azure Active Directory Identity Protection High Severity Alert Detection","enabled":true,"description":"Azure Active Directory Identity Protection High Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T14:39:35.134109Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/5a299f3a-8f4d-4e5e-a775-6d0dbe32bae5","name":"5a299f3a-8f4d-4e5e-a775-6d0dbe32bae5","etag":"\"9000199b-0000-0d00-0000-6390a6820000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProductName == \"Azure Active Directory Identity Protection\"\n and AlertSeverity == \"Medium\" and Status in (\"New\")\n};\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051713 - Azure Active Directory Identity Protection Medium Severity Alert Detection","enabled":true,"description":"Azure Active Directory Identity Protection Medium Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T14:42:59.6091166Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/2965378e-40f8-4d98-adea-1972f96cafde","name":"2965378e-40f8-4d98-adea-1972f96cafde","etag":"\"450176aa-0000-0d00-0000-6389d4cd0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Low","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProviderName == \"Azure Active Directory Identity Protection\"\n and AlertSeverity == \"Low\" and Status in (\"New\", \"Active\")\n};\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051714 - Azure Active Directory Identity Protection Low Severity Alert Detection","enabled":true,"description":"Azure Active Directory Identity Protection Low Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-02T10:34:41.1720466Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/9474fe5b-0119-4dbb-a24e-b7d8c460645d","name":"9474fe5b-0119-4dbb-a24e-b7d8c460645d","etag":"\"90000d40-0000-0d00-0000-6390a5070000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"High","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProductName == \"Office 365 Advanced Threat Protection\"\n        and AlertSeverity == \"High\"\n        and Status in (\"New\", \"Active\")\n};\nunion withsource=\"TenantDetection\"  Mango\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051715 - Microsoft Defender for Office 365 High Severity Alert Detection","enabled":false,"description":"Microsoft Defender for Office 365 High Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T14:36:55.8288929Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/95b80a88-ac64-4b2f-8b6e-335734e715cb","name":"95b80a88-ac64-4b2f-8b6e-335734e715cb","etag":"\"90001f79-0000-0d00-0000-6390a5bd0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProductName == \"Office 365 Advanced Threat Protection\" and AlertSeverity == \"Medium\" and Status in (\"New\", \"Active\")\n};\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051716 - Microsoft Defender for Office 365 Medium Severity Alert Detection","enabled":true,"description":"Microsoft Defender for Office 365 Medium Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T14:39:45.6296244Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/0c310d78-3de0-4573-ab83-b7ccea9ca54b","name":"0c310d78-3de0-4573-ab83-b7ccea9ca54b","etag":"\"9000d29e-0000-0d00-0000-6390a6980000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Low","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProductName == \"Office 365 Advanced Threat Protection\" and AlertSeverity == \"Low\" and Status in (\"New\", \"Active\")\n};\nunion withsource=\"TenantDetection\"  Mango\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051717 - Microsoft Defender for Office 365 Low Severity Alert Detection","enabled":true,"description":" Microsoft Defender for Office 365 Low Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T14:43:21.739216Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/7c1d190d-c363-4667-bb21-f3a95ac4ed52","name":"7c1d190d-c363-4667-bb21-f3a95ac4ed52","etag":"\"d600bb0a-0000-0d00-0000-635e76330000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT4H","queryPeriod":"PT4H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\r\n\t| where ProductName == \"Azure Advanced Threat Protection\" and Status == \"New\" and AlertSeverity == \"High\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051718 - MS Defender for Identity High Severity Alert Detection","enabled":true,"description":"Detecciones de la solución MS Defender for Identity de severidad alta.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-30T13:03:34.8892951Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/7466c000-3409-4c12-87ed-303e192d2f22","name":"7466c000-3409-4c12-87ed-303e192d2f22","etag":"\"d600e111-0000-0d00-0000-635e77060000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\r\n\t| where ProductName == \"Azure Advanced Threat Protection\" and Status == \"New\" and AlertSeverity == \"Medium\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051719 - MS Defender for Identity Medium Severity Alert Detection","enabled":true,"description":"Detección de alertas de severidad media de la solución MS Defender For Identity","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-30T13:07:00.2970628Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/9ce30bc1-1bb0-4e6b-86cf-6a8aabdfb704","name":"9ce30bc1-1bb0-4e6b-86cf-6a8aabdfb704","etag":"\"d600f01e-0000-0d00-0000-635e783c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\r\n\t| where ProductName == \"Azure Advanced Threat Protection\" and Status == \"New\" and AlertSeverity == \"Low\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051720 - MS Defender for Identity Low Severity Alert Detection","enabled":true,"description":"Detección de alertas de severidad baja de la solución MS Defender for Identity","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-30T13:12:11.9433121Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/a2f9cc6f-53e8-4287-ac55-cbd0cddbd8c6","name":"a2f9cc6f-53e8-4287-ac55-cbd0cddbd8c6","etag":"\"8f007e31-0000-0d00-0000-63909fbf0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Low","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n    | where ProductName == \"Microsoft 365 Defender\"\n        and AlertSeverity == \"Low\"\n        and Status in (\"New\")\n}; \nunion withsource=\"TenantDetection\"  Mango\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051724 - 365 Defender Low Severity Alert Detection","enabled":true,"description":"Detección de alertas de severidad baja de la solución 365 Defender","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-07T14:14:14.2583429Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/53f0a1a1-abd4-4c9b-b48a-25fb537a11ff","name":"53f0a1a1-abd4-4c9b-b48a-25fb537a11ff","etag":"\"d6005636-0000-0d00-0000-637b6ec50000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT4H","queryPeriod":"PT4H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\r\n\t| where ProductName == \"Azure Security Center\" and Status == \"New\" and AlertSeverity == \"High\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051721 - MS Defender for Cloud High Severity Alert Detection","enabled":true,"description":"Detección de alertas de severidad alta de la solución MS Defender For Cloud","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-21T12:27:32.9158351Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/fec59a27-fe69-49a9-a733-13704f62f9ec","name":"fec59a27-fe69-49a9-a733-13704f62f9ec","etag":"\"d600fb42-0000-0d00-0000-635e7c180000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let Mango = view () {\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\r\n\t| where ProductName == \"Azure Security Center\" and Status == \"New\" and AlertSeverity == \"Medium\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051722 - MS Defender for Cloud Medium Severity Alert Detection","enabled":true,"description":"Detección de alertas de severidad media de la solución MS Defender for Cloud","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-30T13:28:46.8563282Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/8e191fbf-834b-4894-a224-5321a2962e8e","name":"8e191fbf-834b-4894-a224-5321a2962e8e","etag":"\"d6007e4a-0000-0d00-0000-635e7cf70000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT8H","queryPeriod":"PT8H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\r\n\tworkspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\r\n\t| where ProductName == \"Azure Security Center\" and Status == \"New\" and AlertSeverity == \"Low\"\r\n}; \r\nunion withsource=\"TenantDetection\"  Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051723 - MS Defender for Cloud Low Severity Alert Detection","enabled":true,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-10-30T13:32:08.478355Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/c17b802d-4a63-4ccb-bbd1-e20c09a9014a","name":"c17b802d-4a63-4ccb-bbd1-e20c09a9014a","etag":"\"0d01f313-0000-0d00-0000-6362724c0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"let timeRange = 24h;\r\nlet failureCountThreshold = 30;\r\nlet authenticationWindow = 10m;\r\nlet aadFunc = (tableName:string){\r\n table(tableName)\r\n| where AppDisplayName has \"Azure Portal\"\r\n| extend\r\n     DeviceDetail = todynamic(DeviceDetail),\r\n     //Status = todynamic(Status),\r\n     LocationDetails = todynamic(LocationDetails)\r\n| extend\r\n     OS = tostring(DeviceDetail.operatingSystem),\r\n     Browser = tostring(DeviceDetail.browser),\r\n     //StatusCode = tostring(Status.errorCode),\r\n     //StatusDetails = tostring(Status.additionalDetails),\r\n     State = tostring(LocationDetails.state),\r\n     City = tostring(LocationDetails.city),\r\n     Region = tostring(LocationDetails.countryOrRegion)\r\n// Split out failure versus non-failure types\r\n| extend FailureOrSuccess = iff(ResultType in (\"0\", \"50125\", \"50140\", \"70043\", \"70044\"), \"Success\", \"Failure\")  \r\n// bin outcomes based on authenticationWindow\r\n| summarize take_anyif(UserPrincipalName, not(UserPrincipalName matches regex @\"[a-f\\d]+\\-[a-f\\d]+\\-[a-f\\d]+\\-[a-f\\d]+\\-[a-f\\d]+\")),\r\n     take_anyif(UserDisplayName, isnotempty(UserDisplayName)),  FailureOrSuccessCount = count() by  FailureOrSuccess, UserId, UserDisplayName, AppDisplayName, IPAddress, Browser, OS, State, City, Region, Type, CorrelationId, bin(TimeGenerated, authenticationWindow), ResultType\r\n// sort for sessionizing - by UserPrincipalName and time of the authentication outcome\r\n| sort by UserPrincipalName asc, TimeGenerated asc\r\n| serialize \r\n// sessionize into failure groupings until either the account changes or there is a success\r\n| extend SessionStartedUtc = row_window_session(TimeGenerated, timeRange, authenticationWindow, UserPrincipalName != prev(UserPrincipalName) or prev(FailureOrSuccess) == \"Success\")\r\n// count the failures in each session\r\n| summarize FailureCountBeforeSuccess=sumif(FailureOrSuccessCount, FailureOrSuccess == \"Failure\"), StartTime=min(TimeGenerated), EndTime=max(TimeGenerated), makelist(FailureOrSuccess), IPAddress = make_set(IPAddress), make_set(Browser), make_set(City), make_set(State), make_set(Region), make_set(ResultType) by SessionStartedUtc, UserPrincipalName, CorrelationId, AppDisplayName, UserId, Type\r\n// the session must not start with a success, and must end with one\r\n| where array_index_of(list_FailureOrSuccess, \"Success\") != 0\r\n| where array_index_of(list_FailureOrSuccess, \"Success\") == array_length(list_FailureOrSuccess) - 1\r\n| project-away SessionStartedUtc, list_FailureOrSuccess\r\n// where the number of failures before the success is above the threshold \r\n| where FailureCountBeforeSuccess >= failureCountThreshold \r\n// expand out ip for entity assignment\r\n| mv-expand IPAddress\r\n| extend IPAddress = tostring(IPAddress)\r\n| extend timestamp = StartTime, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress \r\n};\r\n let aadSignin = aadFunc(\"SigninLogs\");\r\n let aadNonInt = aadFunc(\"AADNonInteractiveUserSignInLogs\");\r\n union isfuzzy=true aadSignin, aadNonInt","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCMA050101 - Brute force attack against Azure Portal","enabled":true,"description":"Identifica la evidencia de actividad de fuerza bruta contra Azure Portal al destacar mÃºltiples fallos de autenticaciÃ³n \ny por una autenticaciÃ³n exitosa dentro de una ventana de tiempo determinada. \nReferencias: https://docs.microsoft.com/azure/active-directory/reports-monitoring/reference-sign-ins-error-codes.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-02T13:36:05.2933182Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/8d130cb9-0a0e-463a-adc0-0963893199d3","name":"8d130cb9-0a0e-463a-adc0-0963893199d3","etag":"\"d200c321-0000-0d00-0000-637b65eb0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n\t\t| where (ProviderName == \"MDATP\" or ProductName == \"Microsoft Defender Advanced Threat Protection\") and Status == \"New\" and AlertSeverity == \"High\"\n}; \nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051731 - MS Defender ATP High Severity Alert Detection","enabled":true,"description":"Detecciones de la solución MS Defender ATP y MS Defender for Endpoint de severidad alta.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-21T11:49:51.4362425Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/38b30469-0ae6-44de-b73f-f2ac2cb44205","name":"38b30469-0ae6-44de-b73f-f2ac2cb44205","etag":"\"d40041b6-0000-0d00-0000-637b69340000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n\t\t| where (ProviderName == \"MDATP\" or ProductName == \"Microsoft Defender Advanced Threat Protection\") and Status == \"New\" and AlertSeverity == \"Medium\"\n}; \nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051732 - MS Defender ATP Medium Severity Alert Detection","enabled":true,"description":"Detecciones de la solución MS Defender ATP y MS Defender for Endpoint de severidad media.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-21T12:03:48.7037701Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/bc8fd425-9ed1-4f05-9f5f-119b250f683b","name":"bc8fd425-9ed1-4f05-9f5f-119b250f683b","etag":"\"d40032ed-0000-0d00-0000-637b697a0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n\t\t| where (ProviderName == \"MDATP\" or ProductName == \"Microsoft Defender Advanced Threat Protection\") and Status == \"New\" and AlertSeverity == \"Low\"\n}; \nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051733 - MS Defender ATP Low Severity Alert Detection","enabled":true,"description":"Detecciones de la solución MS Defender ATP y MS Defender for Endpoint de severidad baja.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-21T12:05:02.2469838Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/af6cff55-3e32-4ad6-9c75-b3c5bf7ec7e4","name":"af6cff55-3e32-4ad6-9c75-b3c5bf7ec7e4","etag":"\"d6005037-0000-0d00-0000-637b726f0000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"High","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n\t\t| where ProductName == \"Microsoft Cloud App Security\" and Status == \"New\" and AlertSeverity == \"High\"\n}; \nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051734 - Microsoft Cloud App Security High Severity Alert Detection","enabled":true,"description":"Detecciones de la solución Microsoft Cloud App Security High de severidad alta.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-21T12:43:13.669997Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/6633ea68-7307-4319-a4b3-12ce88aa7709","name":"6633ea68-7307-4319-a4b3-12ce88aa7709","etag":"\"d600e337-0000-0d00-0000-637b73730000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n\t\t| where ProductName == \"Microsoft Cloud App Security\" and Status == \"New\" and AlertSeverity == \"Medium\"\n}; \nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051735 - Microsoft Cloud App Security Medium Severity Alert Detection","enabled":true,"description":"Detecciones de la solución Microsoft Cloud App Security High de severidad media.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-21T12:47:37.8518924Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/ee2a4684-df8c-4a60-bb4b-f6cc92652511","name":"ee2a4684-df8c-4a60-bb4b-f6cc92652511","etag":"\"d600e237-0000-0d00-0000-637b73480000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Low","query":"let Mango = view () {\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\n\t\t| where ProductName == \"Microsoft Cloud App Security\" and Status == \"New\" and AlertSeverity == \"Low\"\n}; \nunion withsource=\"TenantDetection\" Mango","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UC051736 - Microsoft Cloud App Security Low Severity Alert Detection","enabled":true,"description":"Detecciones de la solución Microsoft Cloud App Security de severidad low.","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-21T12:46:51.6071774Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/c5969f67-4315-46ab-aa12-373461cf8bdf","name":"c5969f67-4315-46ab-aa12-373461cf8bdf","etag":"\"4401dfbd-0000-0d00-0000-63877dc00000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT1H","queryPeriod":"PT1H","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"AlertPerResult"},"severity":"Medium","query":"let Mango = view () {\r\n    workspace(\"4d082081-7c2a-4f57-b848-bd64e5c72859\").SecurityAlert\r\n    | where ProviderName == \"OATP\"\r\n        and AlertSeverity == \"High\"\r\n        and Status in (\"New\", \"Active\") | where AlertName!=\"Unusual external user file activity\"\r\n};\r\nunion withsource=\"TenantDetection\"  Mango\r\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"UCMA051701 - Microsoft Defender for Office 365 High Severity Alert Detection ","enabled":true,"description":"Microsoft Defender for Office 365 High Severity Alert Detection","alertRuleTemplateName":null,"lastModifiedUtc":"2022-11-30T15:58:42.0987135Z"}},{"id":"/subscriptions/b3070f35-ba6d-485f-8c10-c02fefd9c5ea/resourceGroups/smartsoc-entelgyinnotecsecurity/providers/Microsoft.OperationalInsights/workspaces/smartsocusecase/providers/Microsoft.SecurityInsights/alertRules/1cf96858-9c40-48ab-9592-957eefabaf37","name":"1cf96858-9c40-48ab-9592-957eefabaf37","etag":"\"4402d039-0000-0d00-0000-639b62280000\"","type":"Microsoft.SecurityInsights/alertRules","kind":"Scheduled","properties":{"queryFrequency":"PT5M","queryPeriod":"P1D","triggerOperator":"GreaterThan","triggerThreshold":0,"eventGroupingSettings":{"aggregationKind":"SingleAlert"},"severity":"Medium","query":"InnotecMultiSecurityEvent\n| where EventID == 4624 and (Computer == \"PAPPSWIFT01\" or Computer == \"LPSB-OLC-005\")\n| summarize count() by cliente, Computer\n","suppressionDuration":"PT5H","suppressionEnabled":false,"tactics":[],"displayName":"TEST - INNOTECMULTI FUNCION - TEST","enabled":false,"description":"","alertRuleTemplateName":null,"lastModifiedUtc":"2022-12-15T18:06:32.7193777Z"}}]}